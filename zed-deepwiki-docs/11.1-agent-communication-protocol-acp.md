<!-- Source: https://deepwiki.com/zed-industries/zed/11.1-agent-communication-protocol-(acp) -->

# 11.1 Agent Communication Protocol (Acp)

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Agent Communication Protocol (ACP)

Relevant source files

  * [crates/acp_thread/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/Cargo.toml>)
  * [crates/acp_thread/src/acp_thread.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/acp_thread.rs>)
  * [crates/acp_thread/src/connection.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/connection.rs>)
  * [crates/acp_thread/src/mention.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/mention.rs>)
  * [crates/agent_servers/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/Cargo.toml>)
  * [crates/agent_servers/src/acp.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs>)
  * [crates/agent_servers/src/agent_servers.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/agent_servers.rs>)
  * [crates/agent_servers/src/claude.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/claude.rs>)
  * [crates/agent_servers/src/custom.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/custom.rs>)
  * [crates/agent_servers/src/e2e_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/e2e_tests.rs>)
  * [crates/agent_servers/src/gemini.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/gemini.rs>)
  * [crates/agent_ui/src/acp/entry_view_state.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/entry_view_state.rs>)
  * [crates/agent_ui/src/acp/message_editor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/message_editor.rs>)
  * [crates/agent_ui/src/acp/thread_view.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/thread_view.rs>)
  * [crates/agent_ui/src/agent_panel.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/agent_panel.rs>)


**Purpose** : This document describes the Agent Client Protocol (ACP), a JSON-RPC based protocol over stdio that enables Zed to communicate with external AI agent processes. ACP defines message types for initialization, session management, streaming responses, tool execution, and authorization flows. External agents like Claude Code, Gemini CLI, Codex, and custom user-defined agents implement this protocol to integrate with Zed.

**Scope** : This document covers the protocol specification, message types, communication flows, capability negotiation, and Zed's implementation. For information about the UI layer and agent thread management, see [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>). For tool system details, see [Tool System](</zed-industries/zed/11.4-tool-system>).

* * *

## Protocol Overview

ACP is a bidirectional JSON-RPC 2.0 protocol operating over stdio (stdin/stdout). Zed spawns external agent processes and communicates via this protocol. The protocol defines:

  * **Request/Response pairs** : Client (Zed) sends requests, agent responds (e.g., `initialize`, `new_session`, `prompt`)
  * **Notifications** : One-way messages from agent to client (e.g., `session_update` for streaming responses)
  * **Capabilities negotiation** : Both sides declare supported features during initialization
  * **Session-based model** : A session represents a conversation thread with persistent state


### Protocol Architecture


**Sources** : [crates/agent_servers/src/acp.rs30-48](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L30-L48>) [crates/agent_servers/src/acp.rs82-149](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L82-L149>)

* * *

## Protocol Initialization Flow

### Connection Establishment


The initialization sequence:

  1. **Process spawn** : Zed spawns the agent binary with stdio pipes
  2. **Protocol handshake** : `initialize` request establishes protocol version and capabilities
  3. **Authentication** (if needed): Some agents require OAuth or API key setup
  4. **Session creation** : Each thread gets a unique session with its own state


**Sources** : [crates/agent_servers/src/acp.rs82-234](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L82-L234>)

### Protocol Version


Zed requires agents to support at least `ProtocolVersion::V1`. Version negotiation occurs during `initialize`:

  * Zed sends its supported version in `InitializeRequest`
  * Agent responds with its version in `InitializeResponse`
  * If agent version < minimum, connection fails with `UnsupportedVersion` error


**Sources** : [crates/agent_servers/src/acp.rs79-201](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L79-L201>)

### Capability Negotiation

#### Client Capabilities

Zed declares its capabilities in `InitializeRequest`:


Capability| Description  
---|---  
`fs.read_text_file`| Agent can request file contents via `fs_read_text_file`  
`fs.write_text_file`| Agent can write file contents via tool calls  
`terminal`| Agent can spawn terminal sessions  
`meta.terminal_output`| Experimental: terminal output streaming  
`meta.terminal-auth`| Experimental: terminal authorization  
  
**Sources** : [crates/agent_servers/src/acp.rs180-195](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L180-L195>)

#### Agent Capabilities

Agent responds with its capabilities in `InitializeResponse`:


Capability| Impact on Zed  
---|---  
`prompt_capabilities.image`| Enables image paste and image mentions in message editor  
`prompt_capabilities.audio`| Enables audio attachments (future)  
`prompt_capabilities.embedded_context`| Sends `Resource` blocks with full content instead of just `ResourceLink`  
  
**Sources** : [crates/agent_servers/src/acp.rs227-229](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L227-L229>) [crates/agent_ui/src/acp/message_editor.rs63-77](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/message_editor.rs#L63-L77>)

* * *

## Core Message Types

### initialize

**Request** : `InitializeRequest`
    
    
    {
      "jsonrpc": "2.0",
      "id": 1,
      "method": "initialize",
      "params": {
        "protocol_version": "v1",
        "client_capabilities": {
          "fs": {
            "read_text_file": true,
            "write_text_file": true
          },
          "terminal": true,
          "meta": {
            "terminal_output": true,
            "terminal-auth": true
          }
        },
        "client_info": {
          "name": "zed",
          "version": "0.165.0",
          "title": "Zed Preview"
        }
      }
    }
    

**Response** : `InitializeResponse`
    
    
    {
      "jsonrpc": "2.0",
      "id": 1,
      "result": {
        "protocol_version": "v1",
        "agent_capabilities": {
          "prompt_capabilities": {
            "image": true,
            "audio": false,
            "embedded_context": true
          }
        },
        "auth_methods": [
          {
            "id": "oauth",
            "name": "Sign in with Browser"
          }
        ],
        "agent_info": {
          "name": "claude-code",
          "version": "0.1.0"
        }
      }
    }
    

**Sources** : [crates/agent_servers/src/acp.rs177-197](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L177-L197>)

* * *

### new_session

**Request** : `NewSessionRequest`
    
    
    {
      "jsonrpc": "2.0",
      "id": 2,
      "method": "new_session",
      "params": {
        "cwd": "/Users/user/project",
        "mcp_servers": [
          {
            "type": "stdio",
            "id": "filesystem",
            "command": "mcp-server-filesystem",
            "args": ["--root", "/Users/user/project"],
            "env": []
          }
        ]
      }
    }
    

**Response** : `NewSessionResponse`
    
    
    {
      "jsonrpc": "2.0",
      "id": 2,
      "result": {
        "session_id": "session-123",
        "modes": {
          "current_mode_id": "edit",
          "available_modes": [
            {"id": "edit", "name": "Edit Mode"},
            {"id": "chat", "name": "Chat Mode"}
          ]
        },
        "models": {
          "current_model_id": "claude-3-5-sonnet",
          "available_models": [
            {"model_id": "claude-3-5-sonnet", "name": "Claude 3.5 Sonnet"}
          ]
        }
      }
    }
    

The `mcp_servers` array allows agents to connect to Model Context Protocol servers for additional context sources.

**Sources** : [crates/agent_servers/src/acp.rs252-323](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L252-L323>)

* * *

### prompt

**Request** : `PromptRequest`
    
    
    {
      "jsonrpc": "2.0",
      "id": 3,
      "method": "prompt",
      "params": {
        "session_id": "session-123",
        "content": [
          {"type": "text", "text": "Read the file "},
          {"type": "resource_link", "uri": "file:///Users/user/project/src/main.rs", "name": "main.rs"},
          {"type": "text", "text": " and explain what it does"}
        ]
      }
    }
    

Content blocks can be:

  * `text`: Plain text
  * `resource_link`: Reference to a file/symbol/URL
  * `resource`: Embedded file content (if `embedded_context` capability enabled)
  * `image`: Base64-encoded image data


**Response** : `PromptResponse`
    
    
    {
      "jsonrpc": "2.0",
      "id": 3,
      "result": {
        "stop_reason": "end_turn"
      }
    }
    

Stop reasons:

  * `end_turn`: Agent completed its response
  * `cancelled`: User canceled generation
  * `max_tokens`: Hit token limit


**Sources** : [crates/agent_servers/src/acp.rs454-492](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L454-L492>) [crates/acp_thread/src/acp_thread.rs1288-1361](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/acp_thread.rs#L1288-L1361>)

* * *

### session_update (Notification)

During `prompt` execution, the agent sends `session_update` notifications to stream responses:

**Assistant Message Update**
    
    
    {
      "jsonrpc": "2.0",
      "method": "session_update",
      "params": {
        "session_id": "session-123",
        "update": {
          "type": "assistant_message",
          "content": "This file contains the main entry point..."
        }
      }
    }
    

**Tool Call Update**
    
    
    {
      "jsonrpc": "2.0",
      "method": "session_update",
      "params": {
        "session_id": "session-123",
        "update": {
          "type": "tool_call",
          "tool_call_id": "call-456",
          "kind": "file_edit",
          "title": "Edit main.rs",
          "is_authorization_required": true,
          "permission_options": [
            {"id": "allow_once", "name": "Allow Once", "kind": "allow_once"},
            {"id": "allow_always", "name": "Allow Always", "kind": "allow_always"},
            {"id": "reject", "name": "Reject", "kind": "reject"}
          ],
          "status": "pending",
          "content": [...]
        }
      }
    }
    

**Sources** : [crates/acp_thread/src/acp_thread.rs1386-1500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/acp_thread.rs#L1386-L1500>)

* * *

## Session Management

### Mode Selection

Agents can support multiple operational modes (e.g., "edit" mode vs "chat" mode). Modes are included in `NewSessionResponse` and can be changed:

**Request** : `SetSessionModeRequest`
    
    
    {
      "jsonrpc": "2.0",
      "id": 4,
      "method": "set_session_mode",
      "params": {
        "session_id": "session-123",
        "mode_id": "chat"
      }
    }
    

**Response** : `SetSessionModeResponse`
    
    
    {
      "jsonrpc": "2.0",
      "id": 4,
      "result": {}
    }
    

Zed applies default modes from user settings during session creation.

**Sources** : [crates/agent_servers/src/acp.rs325-606](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L325-L606>)

* * *

### Model Selection

Agents can support multiple models. Model selection follows the same pattern as modes:

**Request** : `SetSessionModelRequest`
    
    
    {
      "jsonrpc": "2.0",
      "id": 5,
      "method": "set_session_model",
      "params": {
        "session_id": "session-123",
        "model_id": "claude-3-opus"
      }
    }
    

**Response** : `SetSessionModelResponse`
    
    
    {
      "jsonrpc": "2.0",
      "id": 5,
      "result": {}
    }
    

**Sources** : [crates/agent_servers/src/acp.rs364-728](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L364-L728>)

* * *

## Tool Execution Protocol

### Tool Call Update Types

The `session_update` notification includes several tool-related update types:

#### Tool Call Creation/Update
    
    
    {
      "type": "tool_call",
      "tool_call_id": "call-789",
      "kind": "terminal_command",
      "title": "Run tests",
      "is_authorization_required": true,
      "permission_options": [
        {"id": "allow_once", "name": "Allow Once", "kind": "allow_once"},
        {"id": "reject", "name": "Reject", "kind": "reject"}
      ],
      "status": "pending",
      "content": [
        {
          "type": "terminal",
          "terminal_id": "term-1",
          "label": "pytest",
          "cwd": "/Users/user/project"
        }
      ]
    }
    

Fields:

  * `tool_call_id`: Unique identifier for this tool invocation
  * `kind`: Type of tool (e.g., `file_edit`, `terminal_command`, `read_file`)
  * `is_authorization_required`: If true, Zed must send authorization before execution
  * `permission_options`: Available authorization choices
  * `status`: `pending` | `in_progress` | `completed` | `failed`
  * `content`: Tool-specific data (terminal info, diff data, etc.)


**Sources** : [crates/acp_thread/src/acp_thread.rs175-315](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/acp_thread.rs#L175-L315>)

* * *

### Authorization Flow


Authorization workflow:

  1. Agent sends tool call with `is_authorization_required: true`
  2. Zed creates entry with `ToolCallStatus::WaitingForConfirmation` and stores a `oneshot::Sender`
  3. UI displays permission options to user
  4. User selects option; Zed sends `tool_call_authorization_response`
  5. Agent proceeds with execution and streams results


**Sources** : [crates/acp_thread/src/acp_thread.rs410-1746](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/acp_thread.rs#L410-L1746>)

* * *

### Tool Call Content Types

Tool calls include content blocks that vary by tool kind:

#### Terminal Content
    
    
    {
      "type": "terminal",
      "terminal_id": "term-1",
      "label": "npm test",
      "cwd": "/project",
      "output_byte_limit": 10000
    }
    

Zed spawns a PTY for the terminal and displays output inline.

#### Diff Content
    
    
    {
      "type": "diff",
      "path": "src/main.rs",
      "old_text": "fn main() {\n    println!(\"Hello\");\n}",
      "new_text": "fn main() {\n    println!(\"Hello, world!\");\n}"
    }
    

Zed displays the diff with syntax highlighting and allows accepting/rejecting hunks.

**Sources** : [crates/acp_thread/src/acp_thread.rs592-670](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/acp_thread.rs#L592-L670>)

* * *

## Protocol Implementation in Zed

### AcpConnection Structure


**Sources** : [crates/agent_servers/src/acp.rs30-48](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L30-L48>)

* * *

### ClientSideConnection

`ClientSideConnection` is the JSON-RPC transport layer from the `agent-client-protocol` crate:


The connection handles serialization/deserialization and routes notifications to registered handlers.

**Sources** : [crates/agent_servers/src/acp.rs127-134](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L127-L134>)

* * *

### Session Tracking


Each session tracks:

  * **thread** : Weak reference to the `AcpThread` that owns this session
  * **models/session_modes** : State for model and mode selection (if agent supports them)
  * **suppress_abort_err** : Flag to suppress abortion errors during cancellation


When a `session_update` notification arrives, `AcpConnection` looks up the session and forwards the update to the thread.

**Sources** : [crates/agent_servers/src/acp.rs50-437](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L50-L437>)

* * *

### Process Lifecycle


Process management:

  * `AcpConnection` owns `child: smol::process::Child`
  * Three background tasks run concurrently: I/O, stderr logging, exit monitoring
  * On drop, `child.kill()` is called to terminate the process
  * Exit monitoring task notifies all active sessions if process exits unexpectedly


**Sources** : [crates/agent_servers/src/acp.rs82-241](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L82-L241>)

* * *

### Error Handling

Protocol errors use the `acp::Error` type:


Special error handling:

  * `ErrorCode::AuthRequired`: Triggers authentication flow
  * Abort errors during cancellation: Suppressed via `suppress_abort_err` flag
  * Agent-specific errors: Wrapped and converted to Zed error types


**Sources** : [crates/agent_servers/src/acp.rs464-507](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L464-L507>)

* * *

## Advanced Protocol Features

### Streaming Response Handling


The `ClientDelegate` handles incoming notifications:


**Sources** : [crates/agent_servers/src/acp.rs125-772](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L125-L772>)

* * *

### MCP Server Integration

Agents can connect to MCP (Model Context Protocol) servers for additional context:


MCP servers provide:

  * Dynamic context queries (e.g., "search documentation")
  * Resource providers (e.g., database schemas)
  * Tool providers (e.g., API integrations)


**Sources** : [crates/agent_servers/src/acp.rs252-305](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L252-L305>)

* * *

### Default Mode/Model Application

When creating a session, Zed applies user-configured defaults:


This allows users to set preferences like "always use edit mode" or "default to Claude 3.5 Sonnet".

**Sources** : [crates/agent_servers/src/acp.rs325-412](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L325-L412>)

* * *

### Cancellation

Canceling a prompt stops the agent's generation:


The agent receives an aborted connection and should clean up. Zed suppresses abort errors when `suppress_abort_err` is set.

**Sources** : [crates/agent_servers/src/acp.rs430-480](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L430-L480>)

* * *

## Agent Server Implementations

Zed supports multiple ACP-compatible agents through the `AgentServer` trait:

### AgentServer Trait


**Sources** : [crates/agent_servers/src/agent_servers.rs56-91](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/agent_servers.rs#L56-L91>)

* * *

### Built-in Agents

Agent| Implementation| Binary| Notes  
---|---|---|---  
**ClaudeCode**| `crates/agent_servers/src/claude.rs`| `claude-code-acp`| Anthropic's official CLI agent  
**Gemini**| `crates/agent_servers/src/gemini.rs`| `gemini-cli`| Google's CLI with `SURFACE=zed` env  
**Codex**| `crates/agent_servers/src/codex.rs`| `codex`| OpenAI Codex agent  
**CustomAgentServer**| `crates/agent_servers/src/custom.rs`| User-defined| Generic ACP agent wrapper  
  
Connection pattern for all agents:

  1. Look up command in `AgentServerStore`
  2. Apply proxy settings via `load_proxy_env()`
  3. Spawn process via `AcpConnection::stdio()`
  4. Apply default mode/model from user settings


**Sources** : [crates/agent_servers/src/claude.rs24-122](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/claude.rs#L24-L122>) [crates/agent_servers/src/gemini.rs12-80](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/gemini.rs#L12-L80>) [crates/agent_servers/src/codex.rs24-124](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/codex.rs#L24-L124>) [crates/agent_servers/src/custom.rs12-152](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/custom.rs#L12-L152>)

* * *

### Connection Example: ClaudeCode


**Sources** : [crates/agent_servers/src/claude.rs75-116](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/claude.rs#L75-L116>) [crates/agent_servers/src/acp.rs57-234](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L57-L234>)

* * *

## Content Blocks and Context

### Content Block Types

Messages in ACP use typed content blocks:

Type| Fields| Purpose  
---|---|---  
`text`| `text: String`| Plain text content  
`resource_link`| `uri: String, name: String`| Reference to a resource (file, URL, etc.)  
`resource`| `resource: EmbeddedResource`| Full resource content embedded in message  
`image`| `data: Base64String, mime_type: String`| Base64-encoded image  
  
**Sources** : [crates/agent_ui/src/acp/message_editor.rs355-456](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/message_editor.rs#L355-L456>)

* * *

### Resource Links vs Embedded Resources

Depending on the agent's `embedded_context` capability:

**Without embedded_context** (resource links only):
    
    
    [
      {"type": "text", "text": "Look at "},
      {"type": "resource_link", "uri": "file:///path/to/file.rs", "name": "file.rs"}
    ]
    

The agent must use a tool or MCP server to fetch the content.

**With embedded_context** (full content):
    
    
    [
      {"type": "text", "text": "Look at "},
      {
        "type": "resource",
        "resource": {
          "type": "text_resource_contents",
          "uri": "file:///path/to/file.rs",
          "text": "fn main() { ... }"
        }
      }
    ]
    

The content is included directly, reducing round trips.

**Sources** : [crates/agent_ui/src/acp/message_editor.rs397-456](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/message_editor.rs#L397-L456>)

* * *

### Mention URI Scheme

Zed uses URIs to reference various resources:

URI Scheme| Example| Description  
---|---|---  
`file://`| `file:///path/to/file.rs`| File path  
`file://.../path#L10:20`| `file:///main.rs#L10:20`| File with line range  
`file://.../path?symbol=Foo#L10:20`| `file:///main.rs?symbol=Bar#L5:10`| Symbol in file  
`zed:///agent/thread/{id}`| `zed:///agent/thread/session-123?name=Thread`| Reference to another thread  
`zed:///agent/rule/{id}`| `zed:///agent/rule/abc?name=Rule`| Reference to a rule/prompt  
`http://` or `https://`| `https://example.com/api`| Web fetch  
  
**Sources** : [crates/acp_thread/src/mention.rs15-294](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/mention.rs#L15-L294>)

* * *

## Protocol Extensions and Future Work

### MCP Server Integration

Sessions can include MCP (Model Context Protocol) servers for additional context:


The agent can query MCP servers for additional context like documentation, API references, or project-specific data.

**Sources** : [crates/agent_servers/src/acp.rs252-299](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L252-L299>)

### Experimental Features

The client advertises experimental capabilities via `Meta` fields:


These experimental features allow agents to use capabilities that may not be in the stable protocol specification.

**Sources** : [crates/agent_servers/src/acp.rs180-195](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L180-L195>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Agent Communication Protocol (ACP)](<#agent-communication-protocol-acp>)
  * [Protocol Overview](<#protocol-overview>)
  * [Protocol Architecture](<#protocol-architecture>)
  * [Protocol Initialization Flow](<#protocol-initialization-flow>)
  * [Connection Establishment](<#connection-establishment>)
  * [Protocol Version](<#protocol-version>)
  * [Capability Negotiation](<#capability-negotiation>)
  * [Client Capabilities](<#client-capabilities>)
  * [Agent Capabilities](<#agent-capabilities>)
  * [Core Message Types](<#core-message-types>)
  * [initialize](<#initialize>)
  * [new_session](<#new_session>)
  * [prompt](<#prompt>)
  * [session_update (Notification)](<#session_update-notification>)
  * [Session Management](<#session-management>)
  * [Mode Selection](<#mode-selection>)
  * [Model Selection](<#model-selection>)
  * [Tool Execution Protocol](<#tool-execution-protocol>)
  * [Tool Call Update Types](<#tool-call-update-types>)
  * [Tool Call Creation/Update](<#tool-call-creationupdate>)
  * [Authorization Flow](<#authorization-flow>)
  * [Tool Call Content Types](<#tool-call-content-types>)
  * [Terminal Content](<#terminal-content>)
  * [Diff Content](<#diff-content>)
  * [Protocol Implementation in Zed](<#protocol-implementation-in-zed>)
  * [AcpConnection Structure](<#acpconnection-structure>)
  * [ClientSideConnection](<#clientsideconnection>)
  * [Session Tracking](<#session-tracking>)
  * [Process Lifecycle](<#process-lifecycle>)
  * [Error Handling](<#error-handling>)
  * [Advanced Protocol Features](<#advanced-protocol-features>)
  * [Streaming Response Handling](<#streaming-response-handling>)
  * [MCP Server Integration](<#mcp-server-integration>)
  * [Default Mode/Model Application](<#default-modemodel-application>)
  * [Cancellation](<#cancellation>)
  * [Agent Server Implementations](<#agent-server-implementations>)
  * [AgentServer Trait](<#agentserver-trait>)
  * [Built-in Agents](<#built-in-agents>)
  * [Connection Example: ClaudeCode](<#connection-example-claudecode>)
  * [Content Blocks and Context](<#content-blocks-and-context>)
  * [Content Block Types](<#content-block-types>)
  * [Resource Links vs Embedded Resources](<#resource-links-vs-embedded-resources>)
  * [Mention URI Scheme](<#mention-uri-scheme>)
  * [Protocol Extensions and Future Work](<#protocol-extensions-and-future-work>)
  * [MCP Server Integration](<#mcp-server-integration-1>)
  * [Experimental Features](<#experimental-features>)
