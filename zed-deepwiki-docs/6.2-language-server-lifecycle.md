<!-- Source: https://deepwiki.com/zed-industries/zed/6.2-language-server-lifecycle -->

# 6.2 Language Server Lifecycle

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Language Server Lifecycle

Relevant source files

  * [crates/collab/src/tests/editor_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/collab/src/tests/editor_tests.rs>)
  * [crates/collab/src/tests/integration_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/collab/src/tests/integration_tests.rs>)
  * [crates/collab/src/tests/remote_editing_collaboration_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/collab/src/tests/remote_editing_collaboration_tests.rs>)
  * [crates/copilot/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/copilot/Cargo.toml>)
  * [crates/copilot/src/copilot.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/copilot/src/copilot.rs>)
  * [crates/copilot/src/sign_in.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/copilot/src/sign_in.rs>)
  * [crates/editor/src/hover_links.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/hover_links.rs>)
  * [crates/fs/src/fs.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/fs/src/fs.rs>)
  * [crates/git/src/status.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git/src/status.rs>)
  * [crates/lsp/src/lsp.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs>)
  * [crates/prettier/src/prettier.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/prettier/src/prettier.rs>)
  * [crates/prettier/src/prettier_server.js](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/prettier/src/prettier_server.js>)
  * [crates/project/src/buffer_store.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/buffer_store.rs>)
  * [crates/project/src/lsp_command.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_command.rs>)
  * [crates/project/src/lsp_store.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs>)
  * [crates/project/src/prettier_store.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/prettier_store.rs>)
  * [crates/project/src/project.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/project.rs>)
  * [crates/project/src/project_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/project_tests.rs>)
  * [crates/project/src/worktree_store.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/worktree_store.rs>)
  * [crates/proto/proto/lsp.proto](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/proto/lsp.proto>)
  * [crates/remote_server/src/headless_project.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/remote_server/src/headless_project.rs>)
  * [crates/remote_server/src/remote_editing_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/remote_server/src/remote_editing_tests.rs>)
  * [crates/worktree/src/worktree.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/worktree/src/worktree.rs>)
  * [crates/worktree/src/worktree_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/worktree/src/worktree_tests.rs>)


This document describes how language servers are started, initialized, configured, and shut down in Zed. It covers the state management, startup sequence, initialization protocol, and configuration mechanisms.

For information about how language servers are selected and managed across multiple servers, see [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>). For details about LSP requests and responses during normal operation, see [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>). For the overall LSP architecture, see [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>).

## Language Server States

Language servers in Zed progress through distinct states managed by the `LanguageServerState` enum. The system tracks whether a server is starting up, running normally, or has failed.


The `LanguageServerState` enum has two primary variants:

  * **`Starting`** : Contains a `Task` that resolves to an `Option<Arc<LanguageServer>>` and a set of `pending_workspace_folders` that will be added once initialization completes
  * **`Running`** : Contains the running `Arc<LanguageServer>`, associated `CachedLspAdapter`, and buffer state information


Sources: [crates/project/src/lsp_store.rs554-557](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L554-L557>)

## Startup Sequence

The language server startup process is initiated by `LocalLspStore::start_language_server()` and involves multiple asynchronous steps coordinated through spawned tasks.

### Startup Flow Diagram


Sources: [crates/project/src/lsp_store.rs359-570](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L359-L570>) [crates/lsp/src/lsp.rs317-383](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L317-L383>)

### Binary Resolution

Before spawning a language server, Zed must determine the path to the language server binary. This process is handled by `get_language_server_binary()`:

  1. **Manual override check** : If `settings.binary.path` is set, use that path directly
  2. **Adapter resolution** : Otherwise, delegate to the LSP adapter's `get_language_server_command()` method
  3. **Environment merging** : Merge shell environment variables with any adapter-specific or settings-specified environment variables


The binary resolution supports both existing binaries and download-on-demand scenarios with timeouts.

Sources: [crates/project/src/lsp_store.rs572-663](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L572-L663>)

### Process Spawning

The `LanguageServer::new()` method spawns the actual language server process using `smol::process::Command`:

Aspect| Configuration  
---|---  
**Working directory**|  Set to the root path of the project  
**Arguments**|  From `LanguageServerBinary.arguments`  
**Environment**|  From `LanguageServerBinary.env` merged with defaults  
**stdin**|  Piped for JSON-RPC communication  
**stdout**|  Piped for JSON-RPC responses  
**stderr**|  Piped for error logging  
**kill_on_drop**| `true` \- process terminates when `LanguageServer` is dropped  
  
Sources: [crates/lsp/src/lsp.rs327-353](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L327-L353>)

## Initialization Protocol

After spawning the process, Zed follows the LSP initialization protocol to establish a connection with the language server.

### Initialize Request Parameters


The `default_initialize_params()` method constructs these parameters with Zed's supported capabilities.

Sources: [crates/lsp/src/lsp.rs623-897](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L623-L897>)

### Initialization Sequence


The initialization is wrapped in a timeout (`LSP_REQUEST_TIMEOUT` of 120 seconds). If the server fails to respond, the connection is dropped and error handling is triggered.

Sources: [crates/lsp/src/lsp.rs583-621](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L583-L621>) [crates/project/src/lsp_store.rs488-509](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L488-L509>)

### Capability Negotiation

During initialization, the language server returns its `ServerCapabilities`, which are stored in a `RwLock` on the `LanguageServer` instance. These capabilities determine which LSP features are available:

  * **Text synchronization** : How document changes are sent
  * **Completion** : Code completion support and trigger characters
  * **Hover** : Documentation on hover
  * **Signature help** : Parameter information
  * **Definition/Declaration/TypeDefinition/Implementation** : Navigation features
  * **References** : Finding all references
  * **Document highlight** : Highlighting related symbols
  * **Code actions** : Available quick fixes and refactorings
  * **Formatting** : Document and range formatting
  * **Rename** : Symbol renaming support
  * **Diagnostics** : Error and warning reporting (push vs pull)
  * **Inlay hints** : Inline type hints


Sources: [crates/lsp/src/lsp.rs897-925](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L897-L925>)

## Configuration

Language servers receive configuration through multiple mechanisms during and after initialization.

### Configuration Sources


### Initialization Options

Provided in the `initialize` request, these are adapter-specific JSON values that configure server behavior before it starts processing:


Sources: [crates/project/src/lsp_store.rs456-468](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L456-L468>)

### Workspace Configuration

After initialization, Zed sends a `workspace/didChangeConfiguration` notification with workspace-level settings:

  1. **Adapter query** : `workspace_configuration_for_adapter()` is called to get the JSON configuration
  2. **Toolchain context** : The adapter may customize configuration based on the active toolchain (e.g., Rust version, Node version)
  3. **Settings integration** : User settings from `.zed/settings.json` are incorporated
  4. **Notification** : `DidChangeConfigurationParams` is sent to the server


Sources: [crates/project/src/lsp_store.rs447-454](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L447-L454>) [crates/project/src/lsp_store.rs507-509](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L507-L509>)

### Dynamic Configuration Requests

Some language servers request configuration dynamically during operation via the `workspace/configuration` request. Zed handles these requests by:

  1. **Looking up the toolchain** : Finding the toolchain associated with the requesting server
  2. **Querying the adapter** : For each requested scope URI and section, calling the adapter's workspace configuration method
  3. **Returning the values** : Sending back the configuration JSON for each requested item


Sources: [crates/project/src/lsp_store.rs718-778](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L718-L778>)

## Message Handling Setup

Before the language server is marked as running, Zed sets up handlers for various LSP notifications and requests that the server may send.

### Notification Handlers


Key notification handlers installed by `setup_lsp_messages()`:

Notification| Handler Purpose  
---|---  
`PublishDiagnostics`| Merge diagnostics into buffer diagnostic sets, applying adapter-specific processing  
`WorkDoneProgressCreate`| Track progress tokens for long-running operations  
`Progress`| Update progress indicators in the UI  
`ShowMessage`| Display server messages as toasts  
`LogMessage`| Store log messages in the language server log buffer  
  
Sources: [crates/project/src/lsp_store.rs665-779](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L665-L779>)

### Request Handlers

The server can also make requests back to the client:

Request| Handler Purpose  
---|---  
`WorkspaceConfiguration`| Provide configuration values dynamically based on scope URI  
`WorkspaceFolders`| Return the list of workspace folders the server should monitor  
`WorkDoneProgressCreate`| Register new progress tokens  
`RegisterCapability`| Register new server capabilities dynamically (e.g., file watchers)  
`UnregisterCapability`| Remove previously registered capabilities  
`ApplyWorkspaceEdit`| Apply multi-file edits provided by the server  
`InlayHintRefreshRequest`| Refresh all inlay hints  
`CodeLensRefresh`| Refresh all code lenses  
  
Sources: [crates/project/src/lsp_store.rs718-926](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L718-L926>)

## Buffer Registration

Once a language server is running, buffers must be explicitly registered with it before the server can provide features for those buffers.

### Registration Process


The `LspBufferSnapshot` tracks the buffer version last sent to the server, enabling efficient incremental updates.

Sources: [crates/project/src/lsp_store.rs1765-1902](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L1765-L1902>)

### Buffer Synchronization

After registration, buffer edits are synchronized to the server via `textDocument/didChange` notifications:

  1. **Edit detection** : When the buffer changes, `LspStore` computes the diff from the last synchronized version
  2. **Operation grouping** : Multiple rapid edits may be batched
  3. **Notification sending** : `DidChangeTextDocumentParams` with incremental content changes
  4. **Version tracking** : The `LspBufferSnapshot` version is updated


Sources: [crates/project/src/lsp_store.rs1999-2133](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L1999-L2133>)

## Shutdown Process

When a language server is no longer needed, Zed initiates a graceful shutdown following the LSP protocol.

### Shutdown Sequence


Sources: [crates/lsp/src/lsp.rs929-1003](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L929-L1003>)

### Cleanup Actions

When a language server is removed, several cleanup actions occur:

  1. **Buffer notifications** : Send `textDocument/didClose` for all registered buffers
  2. **State removal** : Remove the server from `language_servers` map
  3. **Diagnostic cleanup** : Remove diagnostics associated with this server
  4. **Snapshot cleanup** : Remove buffer snapshots for this server
  5. **Event emission** : Emit `LanguageServerRemoved` event


The `kill_on_drop` flag on the server process ensures that if the `LanguageServer` instance is dropped without explicit shutdown, the process is still terminated.

Sources: [crates/project/src/lsp_store.rs500-504](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L500-L504>) [crates/lsp/src/lsp.rs343-349](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L343-L349>)

## Error Handling

Language server failures can occur at various stages, and Zed handles them appropriately.

### Startup Failures

If the language server fails to start or initialize:

  1. **Error capture** : stderr is captured in `Arc<Mutex<Option<String>>>`
  2. **Status update** : `BinaryStatus::Failed` with error message is set
  3. **User notification** : Error is logged and potentially displayed
  4. **State cleanup** : Server entry is removed from maps
  5. **Retry consideration** : Some errors (e.g., binary download failures) may trigger retry with download


Sources: [crates/project/src/lsp_store.rs533-550](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L533-L550>)

### Runtime Failures

If a running language server crashes or becomes unresponsive:

  1. **Process exit detection** : stdout/stderr handlers detect process termination
  2. **Response handler notification** : Pending requests receive error results
  3. **Automatic cleanup** : Server is removed from the running set
  4. **Optional restart** : For critical servers, Zed may attempt to restart automatically


Sources: [crates/lsp/src/lsp.rs438-466](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L438-L466>)

### Request Timeouts

Individual LSP requests have a timeout (`LSP_REQUEST_TIMEOUT` of 120 seconds):


If the timeout expires, the request future resolves with an error, but the server connection remains active unless the timeout indicates a deeper issue.

Sources: [crates/lsp/src/lsp.rs48](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/lsp/src/lsp.rs#L48-L48>)

## Multi-Server Coordination

A single buffer may be served by multiple language servers simultaneously (e.g., TypeScript for `.vue` files plus Vue language server). The lifecycle management accounts for this:

  * Each server maintains its own registration state for each buffer
  * Diagnostics from multiple servers are merged by `LanguageServerId`
  * Buffer snapshots are tracked per-server to handle different synchronization states
  * Shutdown of one server doesn't affect others serving the same buffer


For more details on how multiple servers coordinate, see [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>).

Sources: [crates/project/src/lsp_store.rs286-299](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/lsp_store.rs#L286-L299>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Language Server Lifecycle](<#language-server-lifecycle>)
  * [Language Server States](<#language-server-states>)
  * [Startup Sequence](<#startup-sequence>)
  * [Startup Flow Diagram](<#startup-flow-diagram>)
  * [Binary Resolution](<#binary-resolution>)
  * [Process Spawning](<#process-spawning>)
  * [Initialization Protocol](<#initialization-protocol>)
  * [Initialize Request Parameters](<#initialize-request-parameters>)
  * [Initialization Sequence](<#initialization-sequence>)
  * [Capability Negotiation](<#capability-negotiation>)
  * [Configuration](<#configuration>)
  * [Configuration Sources](<#configuration-sources>)
  * [Initialization Options](<#initialization-options>)
  * [Workspace Configuration](<#workspace-configuration>)
  * [Dynamic Configuration Requests](<#dynamic-configuration-requests>)
  * [Message Handling Setup](<#message-handling-setup>)
  * [Notification Handlers](<#notification-handlers>)
  * [Request Handlers](<#request-handlers>)
  * [Buffer Registration](<#buffer-registration>)
  * [Registration Process](<#registration-process>)
  * [Buffer Synchronization](<#buffer-synchronization>)
  * [Shutdown Process](<#shutdown-process>)
  * [Shutdown Sequence](<#shutdown-sequence>)
  * [Cleanup Actions](<#cleanup-actions>)
  * [Error Handling](<#error-handling>)
  * [Startup Failures](<#startup-failures>)
  * [Runtime Failures](<#runtime-failures>)
  * [Request Timeouts](<#request-timeouts>)
  * [Multi-Server Coordination](<#multi-server-coordination>)
