<!-- Source: https://deepwiki.com/zed-industries/zed/10.1-mode-state-machine -->

# 10.1 Mode State Machine

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Mode State Machine

Relevant source files

  * [assets/keymaps/vim.json](<https://github.com/zed-industries/zed/blob/4109c9dd/assets/keymaps/vim.json>)
  * [crates/editor/src/selections_collection.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/selections_collection.rs>)
  * [crates/vim/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/Cargo.toml>)
  * [crates/vim/src/command.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/command.rs>)
  * [crates/vim/src/helix.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/helix.rs>)
  * [crates/vim/src/motion.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/motion.rs>)
  * [crates/vim/src/normal.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/normal.rs>)
  * [crates/vim/src/normal/change.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/normal/change.rs>)
  * [crates/vim/src/normal/delete.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/normal/delete.rs>)
  * [crates/vim/src/normal/mark.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/normal/mark.rs>)
  * [crates/vim/src/normal/paste.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/normal/paste.rs>)
  * [crates/vim/src/normal/yank.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/normal/yank.rs>)
  * [crates/vim/src/object.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/object.rs>)
  * [crates/vim/src/replace.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/replace.rs>)
  * [crates/vim/src/state.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/state.rs>)
  * [crates/vim/src/surrounds.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/surrounds.rs>)
  * [crates/vim/src/test/vim_test_context.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/test/vim_test_context.rs>)
  * [crates/vim/src/vim.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs>)
  * [crates/vim/src/visual.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/visual.rs>)


This page documents the Vim mode state machine in Zed, including the different modes, state representation, transition mechanisms, and operator handling. The mode system determines how keystrokes are interpreted and what editing operations are available at any given time.

For information about specific mode behaviors (operators, motions, text objects), see [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>). For visual mode details, see [Visual Mode](</zed-industries/zed/10.3-visual-mode>). For Helix mode integration, see [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>).

* * *

## Mode Types

Zed's Vim implementation supports eight distinct modes, defined in the `Mode` enum. Each mode fundamentally changes how user input is interpreted and what operations are available.

Mode| Enum Value| Description| Display Label  
---|---|---|---  
Normal| `Mode::Normal`| Command mode for navigation and operators| "NORMAL"  
Insert| `Mode::Insert`| Text insertion mode| "INSERT"  
Replace| `Mode::Replace`| Character replacement mode| "REPLACE"  
Visual| `Mode::Visual`| Character-wise selection| "VISUAL"  
Visual Line| `Mode::VisualLine`| Line-wise selection| "VISUAL LINE"  
Visual Block| `Mode::VisualBlock`| Block selection (rectangular)| "VISUAL BLOCK"  
Helix Normal| `Mode::HelixNormal`| Helix-style normal mode| "NORMAL"  
Helix Select| `Mode::HelixSelect`| Helix-style selection mode| "SELECT"  
  
The `Mode` enum includes helper methods for querying mode properties:

  * `is_visual()` returns `true` for `Visual`, `VisualLine`, `VisualBlock`, and `HelixSelect`


**Sources:** [crates/vim/src/state.rs41-76](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/state.rs#L41-L76>)

* * *

## Vim State Structure

The mode state machine is managed by the `Vim` struct, which maintains the current mode, mode history, and pending operations.


### Key State Fields

  * **`mode`** : The current active mode
  * **`last_mode`** : The previous mode, used for toggling and restoration
  * **`temp_mode`** : Flag indicating if currently in temporary normal mode (`ctrl-o` in insert mode)
  * **`operator_stack`** : Stack of pending operators awaiting completion (e.g., `d` waiting for a motion)
  * **`stored_visual_mode`** : Saved visual mode state for restoration with `gv`
  * **`undo_modes`** : Maps transaction IDs to the mode they were recorded in, enabling proper undo behavior


**Sources:** [crates/vim/src/vim.rs489-515](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L489-L515>) [crates/vim/src/state.rs41-52](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/state.rs#L41-L52>) [crates/vim/src/state.rs78-145](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/state.rs#L78-L145>)

* * *

## Mode Transition State Machine

The mode state machine defines valid transitions between modes. Transitions occur through user actions (keybindings) or programmatic calls to `switch_mode`.


### Operator Flow

  1. **Push Operator** : When an operator key is pressed, `push_operator()` adds it to the stack
  2. **Context Changes** : The key context becomes `vim_operator == <operator_name>`
  3. **Motion/Object Entry** : User enters motion or text object
  4. **Execution** : Operator is popped and executed with the motion/object
  5. **Clear** : Stack is cleared, returning to normal command mode


### Context-Based Keybindings

The keymap system uses contexts to enable operator-specific bindings:
    
    
    Context: "vim_operator == d" (delete operator waiting)
      - "d" → delete current line
      - "w" → delete word
      - "d" → delete line
    
    Context: "vim_operator == c" (change operator waiting)
      - "c" → change current line
      - "w" → change word
      - "s" → change surrounds
    
    Context: "vim_operator == a || vim_operator == i" (text object)
      - "w" → word object
      - "p" → paragraph object
      - "(" → parentheses object
    

**Sources:** [crates/vim/src/vim.rs497](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L497-L497>) [assets/keymaps/vim.json600-636](<https://github.com/zed-industries/zed/blob/4109c9dd/assets/keymaps/vim.json#L600-L636>) [assets/keymaps/vim.json680-795](<https://github.com/zed-industries/zed/blob/4109c9dd/assets/keymaps/vim.json#L680-L795>)

* * *

## Temporary Normal Mode

Vim supports a temporary normal mode feature (triggered by `ctrl-o` in insert mode) that allows executing a single normal mode command before automatically returning to insert mode.


### Implementation Details

  * **`temp_mode` flag**: Set to `true` when entering temporary normal mode
  * **`exit_temporary_mode` flag**: Checked after each action to determine if mode should revert
  * **Action** : `TemporaryNormal` in `insert.rs` handles the transition


**Sources:** [crates/vim/src/vim.rs493](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L493-L493>) [crates/vim/src/vim.rs495](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L495-L495>) [crates/vim/src/insert.rs34](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/insert.rs#L34-L34>) [assets/keymaps/vim.json376](<https://github.com/zed-industries/zed/blob/4109c9dd/assets/keymaps/vim.json#L376-L376>)

* * *

## Mode-Specific State Management

Different modes require specific state management:

### Visual Mode State

Visual modes store additional selection state:

  * **`stored_visual_mode`** : Tuple of `(Mode, Vec<bool>)` storing the visual mode type and whether each selection was reversed
  * Used by `gv` command to restore previous visual selection
  * Managed by `create_visual_marks()` and `restore_visual_selection()`


### Insert/Replace Mode State

  * **`replacements`** : Vector of `(Range<Anchor>, String)` tracking character replacements in replace mode
  * Enables undo (`backspace`) in replace mode to restore original characters


### Operator Mode State

  * **`operator_stack`** : Vector of pending operators
  * **`selected_register`** : Optional register selection for yank/delete operations (e.g., `"ay`)
  * **`current_tx`** : Transaction ID for grouping related edits


**Sources:** [crates/vim/src/vim.rs500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L500-L500>) [crates/vim/src/vim.rs498](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L498-L498>) [crates/vim/src/visual.rs42-74](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/visual.rs#L42-L74>) [crates/vim/src/replace.rs28-41](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/replace.rs#L28-L41>)

* * *

## Context System Integration

The mode state machine integrates with Zed's keymap context system through the `extend_key_context` method. This allows keybindings to be mode-specific.

### Mode Context Values

The `VimAddon` trait implementation sets the following context keys:


This creates contexts like:

  * `"vim_mode == normal"`
  * `"vim_mode == insert"`
  * `"vim_mode == visual"`
  * `"vim_mode == operator"` (when operator_stack is not empty)


Additional contexts include:

  * `"VimControl"`: Active when Vim is enabled
  * `"VimCount"`: Active when a count is pending
  * `"vim_operator == <op>"`: Specific operator waiting


### Keymap Structure

Keybindings in `vim.json` are organized by context:


**Sources:** [crates/vim/src/vim.rs479-486](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L479-L486>) [assets/keymaps/vim.json1-3](<https://github.com/zed-industries/zed/blob/4109c9dd/assets/keymaps/vim.json#L1-L3>) [assets/keymaps/vim.json230-265](<https://github.com/zed-industries/zed/blob/4109c9dd/assets/keymaps/vim.json#L230-L265>)

* * *

## Mode Switching Implementation

The `switch_mode` method is the central mechanism for mode transitions. It handles cleanup of the old mode and initialization of the new mode.

### Switch Mode Sequence


### Mode-Specific Behaviors

Different modes require different editor configurations:

Mode| `clip_at_line_ends`| Selection Behavior| Recording  
---|---|---|---  
Normal| `true`| Collapse to single point| Action recording  
Insert| `false`| N/A| Insertion recording  
Replace| `false`| Track replacements| Action recording  
Visual| `false`| Extend selections| N/A  
  
**Sources:** [crates/vim/src/vim.rs638-672](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L638-L672>) [crates/vim/src/visual.rs42-74](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/visual.rs#L42-L74>) [crates/vim/src/insert.rs1-120](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/insert.rs#L1-L120>)

* * *

## Mode Persistence and Undo

Vim tracks which mode was active when each transaction was created to enable proper undo behavior.

### Undo Mode Tracking

  * **`undo_modes`** : HashMap mapping `TransactionId` to the `Mode` it was created in
  * When undoing, Vim can optionally restore the mode that was active
  * Special handling for visual modes to preserve selection state


### Transaction Grouping

  * **`current_tx`** : Tracks the active transaction ID
  * Multiple edits in the same mode are grouped into a single undo unit
  * Mode switches typically end the current transaction


**Sources:** [crates/vim/src/vim.rs504](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L504-L504>) [crates/vim/src/vim.rs502-503](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L502-L503>) [crates/vim/src/normal.rs239-256](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/normal.rs#L239-L256>)

* * *

## Diagram: Code Entity Relationships


**Sources:** [crates/vim/src/vim.rs269-472](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L269-L472>) [crates/vim/src/vim.rs583-621](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/vim.rs#L583-L621>) [crates/vim/src/state.rs1-238](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/vim/src/state.rs#L1-L238>)


Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Mode State Machine](<#mode-state-machine>)
  * [Mode Types](<#mode-types>)
  * [Vim State Structure](<#vim-state-structure>)
  * [Key State Fields](<#key-state-fields>)
  * [Mode Transition State Machine](<#mode-transition-state-machine>)
  * [Transition Actions](<#transition-actions>)
  * [Operator Stack and Waiting States](<#operator-stack-and-waiting-states>)
  * [Operator Flow](<#operator-flow>)
  * [Context-Based Keybindings](<#context-based-keybindings>)
  * [Temporary Normal Mode](<#temporary-normal-mode>)
  * [Implementation Details](<#implementation-details>)
  * [Mode-Specific State Management](<#mode-specific-state-management>)
  * [Visual Mode State](<#visual-mode-state>)
  * [Insert/Replace Mode State](<#insertreplace-mode-state>)
  * [Operator Mode State](<#operator-mode-state>)
  * [Context System Integration](<#context-system-integration>)
  * [Mode Context Values](<#mode-context-values>)
  * [Keymap Structure](<#keymap-structure>)
  * [Mode Switching Implementation](<#mode-switching-implementation>)
  * [Switch Mode Sequence](<#switch-mode-sequence>)
  * [Mode-Specific Behaviors](<#mode-specific-behaviors>)
  * [Mode Persistence and Undo](<#mode-persistence-and-undo>)
  * [Undo Mode Tracking](<#undo-mode-tracking>)
  * [Transaction Grouping](<#transaction-grouping>)
  * [Diagram: Code Entity Relationships](<#diagram-code-entity-relationships>)
