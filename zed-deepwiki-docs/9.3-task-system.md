<!-- Source: https://deepwiki.com/zed-industries/zed/9.3-task-system -->

# 9.3 Task System

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Task System

Relevant source files

  * [crates/project/src/terminals.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs>)
  * [crates/repl/src/outputs/plain.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/repl/src/outputs/plain.rs>)
  * [crates/task/src/task.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/task/src/task.rs>)
  * [crates/terminal/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/Cargo.toml>)
  * [crates/terminal/src/terminal.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs>)
  * [crates/terminal/src/terminal_hyperlinks.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal_hyperlinks.rs>)
  * [crates/terminal_view/src/persistence.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/persistence.rs>)
  * [crates/terminal_view/src/terminal_element.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_element.rs>)
  * [crates/terminal_view/src/terminal_panel.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs>)
  * [crates/terminal_view/src/terminal_view.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_view.rs>)


The Task System manages the execution of user-defined tasks in terminal instances, including environment detection, task lifecycle tracking, and terminal reuse policies. For information about the terminal emulator itself, see [Terminal Core](</zed-industries/zed/9.1-terminal-core>). For terminal UI and rendering, see [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>).

## Overview

The Task System enables users to execute commands (builds, tests, scripts) in integrated terminals with features like environment auto-detection, task status tracking, concurrent execution control, and smart terminal reuse. Tasks are defined by templates that get resolved with context (current file, project variables, etc.) and spawned in terminal instances managed by the system.

**Key Capabilities:**

  * Spawn tasks with full environment setup and variable substitution
  * Track task lifecycle (running, completed, success/failure)
  * Detect and activate Python virtual environments automatically
  * Reuse terminals or spawn new ones based on task configuration
  * Queue non-concurrent tasks and wait for completion
  * Display task status and provide rerun functionality in the UI


Sources: [crates/task/src/task.rs1-432](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/task/src/task.rs#L1-L432>) [crates/terminal/src/terminal.rs820-894](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L820-L894>) [crates/terminal_view/src/terminal_panel.rs524-634](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs#L524-L634>)

## Core Data Structures


**Diagram: Core Task Data Structures**

The `SpawnInTerminal` struct contains all configuration needed to spawn a task, including the command, environment, terminal behavior, and display options. `TaskState` wraps this with execution status and a completion channel. The `Terminal` entity optionally holds a `TaskState` when running a task.

Sources: [crates/task/src/task.rs36-107](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/task/src/task.rs#L36-L107>) [crates/terminal/src/terminal.rs820-893](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L820-L893>)

### SpawnInTerminal Fields

Field| Type| Purpose  
---|---|---  
`id`| `TaskId`| Unique identifier for task affinity and terminal reuse  
`full_label`| `String`| Complete unshortened label  
`label`| `String`| Human-readable tab name  
`command`| `Option<String>`| Executable to run (None for shell)  
`args`| `Vec<String>`| Command arguments  
`command_label`| `String`| Combined command with substituted args for display  
`cwd`| `Option<PathBuf>`| Working directory  
`env`| `HashMap<String, String>`| Environment variable overrides  
`use_new_terminal`| `bool`| Create new terminal or reuse existing  
`allow_concurrent_runs`| `bool`| Allow multiple instances simultaneously  
`reveal`| `RevealStrategy`| When to show the terminal  
`reveal_target`| `RevealTarget`| Where to show output (Center/Dock)  
`hide`| `HideStrategy`| When to hide terminal after completion  
`shell`| `Shell`| Which shell to use (System/Program/WithArguments)  
  
Sources: [crates/task/src/task.rs40-77](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/task/src/task.rs#L40-L77>)

### TaskStatus States


**Diagram: Task Status State Machine**

  * **Unknown** : Task started but terminal closed before exit code reported
  * **Running** : Task currently executing
  * **Completed** : Task finished with success/failure status


The status is updated by `register_task_exit()` when the process exits or `register_terminal_exit()` when the terminal closes prematurely.

Sources: [crates/terminal/src/terminal.rs870-893](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L870-L893>)

## Task Execution Flow


**Diagram: Complete Task Execution Sequence**

Sources: [crates/terminal_view/src/terminal_panel.rs524-634](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs#L524-L634>) [crates/project/src/terminals.rs46-277](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L46-L277>) [crates/terminal/src/terminal.rs406-662](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L406-L662>)

### Task Spawning Entry Points

  1. **TerminalPanel::spawn_task()** \- Primary entry point from UI

     * Handles concurrent execution policy
     * Manages terminal reuse vs. creation
     * Queues non-concurrent tasks
  2. **Project::create_terminal_task()** \- Creates terminal with task

     * Resolves environment variables
     * Detects and activates toolchains
     * Builds shell command with activation
  3. **TerminalBuilder::new()** \- Constructs terminal instance

     * Sets up PTY and event loop
     * Executes activation scripts
     * Returns subscribed Terminal entity


Sources: [crates/terminal_view/src/terminal_panel.rs524-634](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs#L524-L634>) [crates/project/src/terminals.rs46-277](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L46-L277>) [crates/terminal/src/terminal.rs406-662](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L406-L662>)

## Terminal Reuse and Concurrency


**Diagram: Terminal Reuse Decision Flow**

The system determines whether to reuse an existing terminal or create a new one based on:

  * `allow_concurrent_runs`: Can multiple instances run simultaneously?
  * `use_new_terminal`: Should this always spawn a new terminal?
  * Existing terminal availability for the task label


When tasks are not allowed to run concurrently, subsequent spawns are queued in `deferred_tasks` and executed after previous instances complete.

Sources: [crates/terminal_view/src/terminal_panel.rs524-634](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs#L524-L634>) [crates/terminal_view/src/terminal_panel.rs659-705](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs#L659-L705>)

### Key Methods for Terminal Management

**TerminalPanel::terminals_for_task()**

  * Searches all panes for terminals running a specific task label
  * Returns `Vec<(usize, Entity<Pane>, Entity<TerminalView>)>`
  * Filters out non-task terminals and completed tasks


**TerminalPanel::spawn_in_new_terminal()**

  * Creates new terminal based on `reveal_target` (Center or Dock)
  * Delegates to `Project::create_terminal_task()`
  * Adds terminal to appropriate pane


**TerminalPanel::replace_terminal()**

  * Reuses existing terminal for new task execution
  * Replaces task state while keeping terminal instance
  * Updates UI to show new task


Sources: [crates/terminal_view/src/terminal_panel.rs659-705](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs#L659-L705>) [crates/terminal_view/src/terminal_panel.rs615-634](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_panel.rs#L615-L634>)

## Environment Detection and Activation

The task system automatically detects Python virtual environments and generates activation scripts that run before the task command.


**Diagram: Environment Detection and Activation Flow**

Sources: [crates/project/src/terminals.rs96-249](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L96-L249>) [crates/terminal/src/terminal.rs630-649](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L630-L649>)

### Activation Script Generation

The activation process for Python virtual environments:

  1. **Detect Virtual Environment**

     * Project calls `active_toolchain()` for Python language
     * Returns toolchain information if venv is detected
  2. **Generate Activation Script**

     * Language plugin provides `toolchain_lister()`
     * Calls `activation_script(toolchain, shell_kind, cx)`
     * Returns shell-specific activation commands (e.g., `source venv/bin/activate`)
  3. **Apply Activation**

     * For remote: Wrap entire command with activation prefix
     * For local: Insert activation before command in shell
     * Scripts are joined with shell-specific command separators
  4. **Execute in Terminal**

     * Activation script written to PTY before task command
     * Clear screen command sent after activation
     * Task command then executes in activated environment


Sources: [crates/project/src/terminals.rs117-249](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L117-L249>) [crates/terminal/src/terminal.rs630-649](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L630-L649>)

### Shell-Specific Command Building

Different shells require different handling for activation and command chaining:

Shell| Separator| Activation Handling  
---|---|---  
Bash/Zsh| `&&` or `;`| Chain with separator  
PowerShell| `;`| Chain with separator  
Cmd| `&&`| Wrap entire command in quotes  
Fish| `;`| Chain with separator  
  
The `ShellKind::sequential_commands_separator()` method provides the appropriate separator, and `ShellBuilder` handles proper quoting and escaping for each shell type.

Sources: [crates/project/src/terminals.rs162-234](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L162-L234>)

## Task Status Tracking and UI Integration


**Diagram: Task Status Tracking and UI Flow**

Sources: [crates/terminal/src/terminal.rs945-975](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L945-L975>) [crates/terminal_view/src/terminal_view.rs492-501](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_view.rs#L492-L501>) [crates/terminal_view/src/terminal_view.rs812-829](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_view.rs#L812-L829>)

### Status Update Mechanism

**Process Exit Events**

  * Alacritty emits `AlacTermEvent::ChildExit(error_code)` when process terminates
  * `AlacTermEvent::Exit` emitted for abnormal terminal closure
  * Both trigger `Terminal::register_task_finished()`


**Status Registration**

  * `register_task_finished()` updates `TaskStatus` based on exit code
  * Success: exit code 0
  * Failure: non-zero exit code
  * Sends status through `completion_tx` channel


**Completion Notification**

  * `TaskState::completion_rx` receives `Option<ExitStatus>`
  * `TerminalPanel` monitors completion for deferred tasks
  * Triggers execution of queued tasks waiting on this terminal


Sources: [crates/terminal/src/terminal.rs945-975](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L945-L975>) [crates/terminal/src/terminal.rs1811-1835](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L1811-L1835>)

### Task UI Components

**Rerun Button** [crates/terminal_view/src/terminal_view.rs812-829](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_view.rs#L812-L829>)

  * Displayed when `spawned_task.show_rerun` is true
  * Clicking dispatches `Rerun` action with task ID
  * Action configured with: 
    * `allow_concurrent_runs: true`
    * `use_new_terminal: false`
    * `reevaluate_context: false`


**Task Status Indicator**

  * Shows task status in terminal tab (Running/Completed)
  * Uses bell icon for attention when needed
  * Updates via `ItemEvent::UpdateTab` emissions


**Breadcrumb Display**

  * Terminal breadcrumb shows task label when available
  * Falls back to shell program name or working directory
  * Updates via `Event::BreadcrumbsChanged` from terminal


Sources: [crates/terminal_view/src/terminal_view.rs812-829](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_view.rs#L812-L829>) [crates/terminal_view/src/terminal_view.rs1097-1107](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal_view/src/terminal_view.rs#L1097-L1107>)

## Remote Terminal Task Execution

For SSH/remote projects, task execution requires special handling to properly transmit commands and environment to the remote host.


**Diagram: Remote Task Execution**

Key differences for remote tasks:

  * `create_remote_shell()` wraps commands with remote execution
  * Environment variables bundled into command template
  * Activation scripts formatted for remote shell
  * Working directory path is remote filesystem path


Sources: [crates/project/src/terminals.rs564-591](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L564-L591>) [crates/terminal/src/terminal.rs416-419](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal.rs#L416-L419>)

### Remote vs Local Shell Creation

**create_remote_shell()** [crates/project/src/terminals.rs564-591](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L564-L591>)

  * Takes spawn command and environment
  * Calls `RemoteClient::build_command()` to wrap for remote execution
  * Returns `(Shell, HashMap<String, String>)` configured for remote


**Local Shell Creation** [crates/project/src/terminals.rs194-234](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L194-L234>)

  * Uses `Shell::WithArguments` directly with activation script
  * Activation and command chained with shell-specific separators
  * Working directory set via PTY options


The remote path ensures activation scripts execute on the remote host before the task command, maintaining the same environment detection behavior for both local and remote projects.

Sources: [crates/project/src/terminals.rs117-234](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L117-L234>) [crates/project/src/terminals.rs564-591](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/terminals.rs#L564-L591>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Task System](<#task-system>)
  * [Overview](<#overview>)
  * [Core Data Structures](<#core-data-structures>)
  * [SpawnInTerminal Fields](<#spawninterminal-fields>)
  * [TaskStatus States](<#taskstatus-states>)
  * [Task Execution Flow](<#task-execution-flow>)
  * [Task Spawning Entry Points](<#task-spawning-entry-points>)
  * [Terminal Reuse and Concurrency](<#terminal-reuse-and-concurrency>)
  * [Key Methods for Terminal Management](<#key-methods-for-terminal-management>)
  * [Environment Detection and Activation](<#environment-detection-and-activation>)
  * [Activation Script Generation](<#activation-script-generation>)
  * [Shell-Specific Command Building](<#shell-specific-command-building>)
  * [Task Status Tracking and UI Integration](<#task-status-tracking-and-ui-integration>)
  * [Status Update Mechanism](<#status-update-mechanism>)
  * [Task UI Components](<#task-ui-components>)
  * [Remote Terminal Task Execution](<#remote-terminal-task-execution>)
  * [Remote vs Local Shell Creation](<#remote-vs-local-shell-creation>)
