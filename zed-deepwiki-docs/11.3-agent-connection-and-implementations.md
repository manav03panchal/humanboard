<!-- Source: https://deepwiki.com/zed-industries/zed/11.3-agent-connection-and-implementations -->

# 11.3 Agent Connection And Implementations

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Agent Connection and Implementations

Relevant source files

  * [crates/acp_thread/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/Cargo.toml>)
  * [crates/acp_thread/src/acp_thread.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/acp_thread.rs>)
  * [crates/acp_thread/src/connection.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/connection.rs>)
  * [crates/acp_thread/src/mention.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/mention.rs>)
  * [crates/agent_servers/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/Cargo.toml>)
  * [crates/agent_servers/src/acp.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs>)
  * [crates/agent_servers/src/agent_servers.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/agent_servers.rs>)
  * [crates/agent_servers/src/claude.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/claude.rs>)
  * [crates/agent_servers/src/custom.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/custom.rs>)
  * [crates/agent_servers/src/e2e_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/e2e_tests.rs>)
  * [crates/agent_servers/src/gemini.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/gemini.rs>)
  * [crates/agent_ui/src/acp/entry_view_state.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/entry_view_state.rs>)
  * [crates/agent_ui/src/acp/message_editor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/message_editor.rs>)
  * [crates/agent_ui/src/acp/thread_view.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/acp/thread_view.rs>)
  * [crates/agent_ui/src/agent_panel.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_ui/src/agent_panel.rs>)


This document describes the agent connection architecture in Zed's AI agent system, focusing on the abstraction layers that enable multiple agent backends. It covers the `AgentConnection` trait that defines the protocol interface, the `AcpConnection` stdio-based implementation, and the various `AgentServer` implementations (Gemini CLI, Claude Code, Codex, and custom agents).

For information about the Agent Communication Protocol (ACP) message types and protocol details, see [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>). For information about UI components and thread management, see [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>).

## Architecture Overview

The agent connection system uses a two-layer abstraction to separate agent-specific concerns (authentication, installation, configuration) from the underlying communication protocol.


**Sources:** [crates/agent_servers/src/agent_servers.rs56-96](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/agent_servers.rs#L56-L96>) [crates/acp_thread/src/connection.rs22-96](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/connection.rs#L22-L96>) [crates/agent_servers/src/acp.rs32-48](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L32-L48>)

## AgentConnection Trait

The `AgentConnection` trait defines the low-level protocol interface that all agent backends must implement. It provides methods for thread lifecycle, authentication, sending prompts, and optional capabilities.

### Core Methods

Method| Purpose| Returns  
---|---|---  
`new_thread()`| Creates a new conversation thread| `Task<Result<Entity<AcpThread>>>`  
`prompt()`| Sends a user message and receives agent response| `Task<Result<acp::PromptResponse>>`  
`cancel()`| Cancels an in-progress generation| `()`  
`auth_methods()`| Lists available authentication methods| `&[acp::AuthMethod]`  
`authenticate()`| Authenticates using a specific method| `Task<Result<()>>`  
  

**Sources:** [crates/acp_thread/src/connection.rs22-96](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/connection.rs#L22-L96>)

### Optional Trait Methods

The `AgentConnection` trait provides optional capabilities through methods that return `Option<Rc<dyn Trait>>`:

  * **`resume()`** : Returns an `AgentSessionResume` for resuming saved threads
  * **`truncate()`** : Returns an `AgentSessionTruncate` for editing message history
  * **`set_title()`** : Returns an `AgentSessionSetTitle` for renaming threads
  * **`model_selector()`** : Returns an `AgentModelSelector` for model selection UI
  * **`session_modes()`** : Returns an `AgentSessionModes` for mode switching
  * **`telemetry()`** : Returns an `AgentTelemetry` for analytics integration


**Sources:** [crates/acp_thread/src/connection.rs43-89](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/connection.rs#L43-L89>)

## AcpConnection Implementation

`AcpConnection` is the primary implementation of `AgentConnection`, communicating with external agent processes via stdio using the Agent Communication Protocol (ACP).

### Connection Structure


**Sources:** [crates/agent_servers/src/acp.rs32-48](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L32-L48>) [crates/agent_servers/src/acp.rs50-55](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L50-L55>)

### Connection Initialization

The `connect()` function establishes a connection to an agent server through several steps:

  1. **Process Spawning** : Spawns the agent executable with configured environment and working directory
  2. **Protocol Handshake** : Sends `initialize` request with client capabilities
  3. **Capability Negotiation** : Receives agent capabilities and authentication methods
  4. **Session Registration** : Registers connection in global `AcpConnectionRegistry`


**Sources:** [crates/agent_servers/src/acp.rs57-76](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L57-L76>) [crates/agent_servers/src/acp.rs82-225](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L82-L225>)

### Session Management

When `new_thread()` is called, `AcpConnection`:

  1. **Creates Session** : Sends `new_session` request with working directory and MCP servers
  2. **Handles Authentication** : Converts auth errors into `AuthRequired` exceptions
  3. **Applies Default Settings** : Sets default mode and model from user preferences
  4. **Creates Thread Entity** : Instantiates `AcpThread` with session ID and connection reference
  5. **Registers Session** : Stores session metadata in `sessions` HashMap


**Sources:** [crates/agent_servers/src/acp.rs248-439](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L248-L439>)

### MCP Server Integration

For local projects, `AcpConnection` passes configured Model Context Protocol (MCP) servers to agents during session creation. This enables agents to access additional tools and context from MCP servers.

**Sources:** [crates/agent_servers/src/acp.rs260-305](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L260-L305>)

## AgentServer Trait

The `AgentServer` trait defines the high-level interface for agent implementations. It handles agent-specific concerns like installation, authentication flows, and configuration.

### Core Methods


**Sources:** [crates/agent_servers/src/agent_servers.rs56-96](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/agent_servers.rs#L56-L96>)

### AgentServerDelegate

The `AgentServerDelegate` struct provides context to agent servers during connection:

  * **`store`** : Reference to `AgentServerStore` for accessing agent configurations
  * **`project`** : Reference to `Project` for file system access
  * **`status_tx`** : Optional channel for sending connection status updates
  * **`new_version_available`** : Optional channel for notifying about updates


**Sources:** [crates/agent_servers/src/agent_servers.rs29-54](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/agent_servers.rs#L29-L54>)

## Built-in Agent Implementations

Zed includes implementations for several popular agent backends.

### Gemini CLI


The Gemini implementation:

  * Retrieves API key from `GoogleLanguageModelProvider`
  * Sets `SURFACE=zed` environment variable to identify Zed as the client
  * Passes proxy settings from Zed configuration
  * Delegates to `crate::acp::connect()` for stdio communication


**Sources:** [crates/agent_servers/src/gemini.rs14-79](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/gemini.rs#L14-L79>)

### Claude Code


The Claude Code implementation:

  * Reads/writes default mode and model from settings file
  * Uses `CLAUDE_CODE_NAME` constant for agent identification
  * Provides standard ACP connection via stdio


**Sources:** [crates/agent_servers/src/claude.rs17-122](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/claude.rs#L17-L122>)

### Codex

The Codex implementation follows the same pattern as Claude Code, connecting to OpenAI's Codex agent via the ACP protocol over stdio.

**Sources:** [crates/agent_servers/src/codex.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/codex.rs>) (referenced in imports)

### Custom Agents


The `CustomAgentServer` enables users to configure arbitrary agent executables:

  * **Name-based identification** : Uses user-provided name as key
  * **Flexible configuration** : Supports both extension-provided and custom commands
  * **Settings persistence** : Stores mode/model preferences per agent
  * **Standard protocol** : Communicates via ACP over stdio


**Sources:** [crates/agent_servers/src/custom.rs12-152](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/custom.rs#L12-L152>)

## Connection Lifecycle

The complete lifecycle of an agent connection involves several phases:

### 1\. Agent Selection and Spawning


**Sources:** [crates/agent_servers/src/gemini.rs37-60](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/gemini.rs#L37-L60>) [crates/agent_servers/src/claude.rs89-103](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/claude.rs#L89-L103>)

### 2\. Protocol Initialization


**Sources:** [crates/agent_servers/src/acp.rs177-201](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L177-L201>)

### 3\. Session Creation


**Sources:** [crates/agent_servers/src/acp.rs307-439](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L307-L439>)

### 4\. Conversation


**Sources:** [crates/agent_servers/src/acp.rs455-493](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L455-L493>)

### 5\. Termination

When an `AcpConnection` is dropped:

  1. The `child` process is killed via `Drop` implementation
  2. IO tasks are cancelled automatically
  3. All active sessions are notified via `_wait_task`
  4. Each `AcpThread` receives `LoadError::Exited` event


**Sources:** [crates/agent_servers/src/acp.rs236-241](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L236-L241>) [crates/agent_servers/src/acp.rs150-167](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L150-L167>)

## Model and Mode Selection

Agents that support model or mode selection implement additional capabilities through the `AgentModelSelector` and `AgentSessionModes` traits.

### Model Selection


The `AcpConnection` implements model selection by:

  1. Storing `SessionModelState` received during session creation
  2. Providing `AgentModelSelector` implementation via `model_selector()` method
  3. Sending `set_session_model` requests when user changes model
  4. Updating local state optimistically and reverting on error


**Sources:** [crates/agent_servers/src/acp.rs326-412](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L326-L412>) [crates/acp_thread/src/connection.rs163-205](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/connection.rs#L163-L205>)

### Mode Selection


Mode selection follows the same pattern as model selection, with optimistic updates and error handling.

**Sources:** [crates/agent_servers/src/acp.rs329-368](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L329-L368>) [crates/acp_thread/src/connection.rs120-127](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/acp_thread/src/connection.rs#L120-L127>)

## Error Handling

The connection layer handles several error conditions:

### Authentication Errors

When an agent requires authentication, the protocol layer converts `AuthRequired` errors into structured exceptions that the UI layer can handle:


**Sources:** [crates/agent_servers/src/acp.rs311-322](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L311-L322>) [crates/agent_servers/src/acp.rs477-479](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L477-L479>)

### Version Incompatibility

If an agent reports a protocol version below `MINIMUM_SUPPORTED_VERSION`, the connection fails with `UnsupportedVersion` error:

**Sources:** [crates/agent_servers/src/acp.rs79](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L79-L79>) [crates/agent_servers/src/acp.rs198-201](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L198-L201>)

### Process Exit

When the agent process exits unexpectedly, the `_wait_task` notifies all active threads via `LoadError::Exited`:

**Sources:** [crates/agent_servers/src/acp.rs150-167](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/acp.rs#L150-L167>)

## Proxy and Environment Configuration

All agent implementations load proxy configuration from Zed settings and pass them to agent processes:


The `load_proxy_env()` function:

  * Reads `ProxySettings` from global settings store
  * Sets `HTTP_PROXY` or `HTTPS_PROXY` based on scheme
  * Sets `NO_PROXY` for localhost to allow local MCP servers
  * Returns HashMap of environment variables to pass to agent


**Sources:** [crates/agent_servers/src/agent_servers.rs98-121](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent_servers/src/agent_servers.rs#L98-L121>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Agent Connection and Implementations](<#agent-connection-and-implementations>)
  * [Architecture Overview](<#architecture-overview>)
  * [AgentConnection Trait](<#agentconnection-trait>)
  * [Core Methods](<#core-methods>)
  * [Optional Trait Methods](<#optional-trait-methods>)
  * [AcpConnection Implementation](<#acpconnection-implementation>)
  * [Connection Structure](<#connection-structure>)
  * [Connection Initialization](<#connection-initialization>)
  * [Session Management](<#session-management>)
  * [MCP Server Integration](<#mcp-server-integration>)
  * [AgentServer Trait](<#agentserver-trait>)
  * [Core Methods](<#core-methods-1>)
  * [AgentServerDelegate](<#agentserverdelegate>)
  * [Built-in Agent Implementations](<#built-in-agent-implementations>)
  * [Gemini CLI](<#gemini-cli>)
  * [Claude Code](<#claude-code>)
  * [Codex](<#codex>)
  * [Custom Agents](<#custom-agents>)
  * [Connection Lifecycle](<#connection-lifecycle>)
  * [1\. Agent Selection and Spawning](<#1-agent-selection-and-spawning>)
  * [2\. Protocol Initialization](<#2-protocol-initialization>)
  * [3\. Session Creation](<#3-session-creation>)
  * [4\. Conversation](<#4-conversation>)
  * [5\. Termination](<#5-termination>)
  * [Model and Mode Selection](<#model-and-mode-selection>)
  * [Model Selection](<#model-selection>)
  * [Mode Selection](<#mode-selection>)
  * [Error Handling](<#error-handling>)
  * [Authentication Errors](<#authentication-errors>)
  * [Version Incompatibility](<#version-incompatibility>)
  * [Process Exit](<#process-exit>)
  * [Proxy and Environment Configuration](<#proxy-and-environment-configuration>)
