<!-- Source: https://deepwiki.com/zed-industries/zed/8.4-diff-system -->

# 8.4 Diff System

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Diff System

Relevant source files

  * [crates/buffer_diff/src/buffer_diff.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs>)
  * [crates/collab/src/rpc.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/collab/src/rpc.rs>)
  * [crates/editor/src/actions.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/actions.rs>)
  * [crates/editor/src/code_completion_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/code_completion_tests.rs>)
  * [crates/editor/src/code_context_menus.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/code_context_menus.rs>)
  * [crates/editor/src/editor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs>)
  * [crates/editor/src/editor_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_tests.rs>)
  * [crates/editor/src/element.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs>)
  * [crates/fs/src/fake_git_repo.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/fs/src/fake_git_repo.rs>)
  * [crates/git/src/git.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git/src/git.rs>)
  * [crates/git/src/repository.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git/src/repository.rs>)
  * [crates/git_ui/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/Cargo.toml>)
  * [crates/git_ui/src/branch_picker.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/branch_picker.rs>)
  * [crates/git_ui/src/commit_modal.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/commit_modal.rs>)
  * [crates/git_ui/src/git_panel.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/git_panel.rs>)
  * [crates/git_ui/src/git_ui.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/git_ui.rs>)
  * [crates/git_ui/src/project_diff.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/project_diff.rs>)
  * [crates/language/src/buffer.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs>)
  * [crates/language/src/buffer_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer_tests.rs>)
  * [crates/language/src/syntax_map.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/syntax_map.rs>)
  * [crates/multi_buffer/src/anchor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/anchor.rs>)
  * [crates/multi_buffer/src/multi_buffer.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs>)
  * [crates/multi_buffer/src/multi_buffer_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer_tests.rs>)
  * [crates/project/src/git_store.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs>)
  * [crates/proto/proto/git.proto](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/proto/git.proto>)
  * [crates/proto/proto/zed.proto](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/proto/zed.proto>)
  * [crates/proto/src/proto.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/src/proto.rs>)


## Purpose and Scope

The Diff System is responsible for computing, representing, and displaying git differences (diffs) in Zed's editor. It bridges git repository state with the visual representation of changes in the editor UI, enabling users to see modifications, stage/unstage hunks, and navigate between changes.

This page covers:

  * Diff computation from git bases (HEAD and index)
  * Diff data structures and their transformations
  * Rendering of diff hunks in the editor gutter and inline
  * Operations like staging, unstaging, and expanding hunks
  * Integration with the Editor and MultiBuffer systems


For git repository operations like commit and push, see [Repository Operations](</zed-industries/zed/8.3-repository-operations>). For git panel UI and user interactions, see [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>). For overall git state management, see [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>).

Sources: [crates/multi_buffer/src/multi_buffer.rs142-186](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L142-L186>) [crates/buffer_diff/src/buffer_diff.rs1-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L1-L100>) [crates/editor/src/editor.rs306-318](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L306-L318>)

* * *

## Architecture Overview

The diff system has several layers that transform git diff data into visual representations:


**Key Components:**

  * `BufferDiff`: Entity that computes diffs using git2, comparing buffer text against git bases
  * `MultiBufferDiffHunk`: Represents a diff hunk with multibuffer coordinates
  * `DisplayDiffHunk`: Display-level representation with folding state
  * `DiffTransform`: Transforms in multibuffer that represent inserted/deleted content
  * `EditorElement`: Renders diff hunks in gutter and inline


Sources: [crates/buffer_diff/src/buffer_diff.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs>) [crates/multi_buffer/src/multi_buffer.rs142-186](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L142-L186>) [crates/editor/src/editor.rs306-318](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L306-L318>) [crates/project/src/git_store.rs99-137](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs#L99-L137>)

* * *

## Diff Computation

### Base Text Loading

Diffs are computed by comparing the current buffer text against git "base" texts. There are two base texts:

  1. **HEAD text** : The committed version (from `git cat-file`)
  2. **Index text** : The staged version (from `git show :path`)


The `BufferGitState` in `GitStore` manages this process:

  * Tracks `head_text` and `index_text` for each buffer
  * Monitors `hunk_staging_operation_count` to ensure base texts are current
  * Spawns `recalculate_diff_task` when buffer or bases change


Sources: [crates/project/src/git_store.rs110-137](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs#L110-L137>) [crates/buffer_diff/src/buffer_diff.rs1-50](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L1-L50>) [crates/git/src/repository.rs410-450](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git/src/repository.rs#L410-L450>)

### Diff Algorithm

`BufferDiff` uses the git2 (libgit2) library to compute diffs:


The computation happens in `BufferDiff::recalculate`:

  1. Create a git2 `Patch` comparing base text and buffer text
  2. Iterate through hunks in the patch
  3. Extract hunk header info (old/new line ranges)
  4. Compute word-level diffs within changed lines
  5. Convert to `MultiBufferDiffHunk` with anchors


Sources: [crates/buffer_diff/src/buffer_diff.rs200-400](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L200-L400>)

### Diff Types

The system supports two types of diffs:

Diff Type| Base| Purpose  
---|---|---  
**Unstaged**|  Index| Shows working directory changes (not yet staged)  
**Uncommitted**|  HEAD| Shows all uncommitted changes (staged + unstaged)  
  
Both diffs are computed independently and can be displayed simultaneously:

  * Editor gutter shows **unstaged** diff by default
  * `ProjectDiff` view can show either type
  * `DiffHunkSecondaryStatus` indicates if a hunk appears in both diffs


Sources: [crates/project/src/git_store.rs150-154](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs#L150-L154>) [crates/buffer_diff/src/buffer_diff.rs50-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L50-L100>)

* * *

## Diff Data Structures

### MultiBufferDiffHunk

The primary diff hunk structure, representing a diff in multibuffer coordinates:


Key methods:

  * `status()`: Returns `DiffHunkStatus` (Added/Modified/Deleted based on ranges)
  * `is_created_file()`: True if hunk represents entire new file
  * `multi_buffer_range()`: Returns anchor range in multibuffer coordinates


Sources: [crates/multi_buffer/src/multi_buffer.rs142-186](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L142-L186>)

### DiffHunkStatus

Represents the type of change in a hunk:


The status is derived from the ranges:

  * **Deleted** : `buffer_range` is empty (no lines in current buffer)
  * **Added** : `diff_base_byte_range` is empty (no lines in base)
  * **Modified** : Both ranges non-empty


Sources: [crates/buffer_diff/src/buffer_diff.rs100-150](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L100-L150>) [crates/multi_buffer/src/multi_buffer.rs161-173](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L161-L173>)

### DisplayDiffHunk

Editor-level representation with display state:

  * **Folded** : Collapsed hunk shown as gutter indicator
  * **Unfolded** : Expanded hunk showing full diff content inline


Sources: [crates/editor/src/editor.rs306-318](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L306-L318>)

* * *

## Diff Rendering

### Gutter Indicators

Diff hunks are rendered in the editor's gutter (line number area) as colored bars:


The rendering process in `EditorElement`:

  1. `layout_gutter()` identifies visible diff hunks
  2. For each hunk, renders a colored bar indicating status: 
     * Green: Added lines
     * Yellow/Orange: Modified lines
     * Red: Deleted lines
  3. If hunk is hovered, renders control buttons (stage/unstage)


Sources: [crates/editor/src/element.rs1000-1200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs#L1000-L1200>)

### Expanded Hunks

When a folded hunk is expanded (toggled), it displays inline diff content:
    
    
    // Folded state (in gutter):
    | 10  fn calculate() {
    [M] 11      let x = value * 2;
    | 12      return x;
    
    // Unfolded state (inline expanded):
    | 10  fn calculate() {
    [-] 11      let x = value;        // Old line (deleted)
    [+] 11      let x = value * 2;    // New line (added)
    | 12      return x;
    

The expansion is managed by:

  * `toggle_selected_diff_hunks()` action toggles fold state
  * `DisplayDiffHunk::Unfolded` stores expanded content
  * `EditorElement` renders old and new text with highlighting


Sources: [crates/editor/src/editor.rs7000-7200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L7000-L7200>) [crates/editor/src/element.rs2000-2200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs#L2000-L2200>)

### Word-Level Diffs

Within modified lines, character-level differences are highlighted:
    
    
    Old: let result = calculate(value);
                 ^^^^^^^^        ^^^^^
    New: let result = compute_sum(data);
                 ^^^^^^^^^^^    ^^^^
    

Word diffs are computed during hunk calculation:

  1. Extract old and new line text
  2. Use `language::text_diff()` to find character ranges
  3. Store as `word_diffs: Vec<Range<MultiBufferOffset>>`
  4. Render with distinct background color


Sources: [crates/buffer_diff/src/buffer_diff.rs300-400](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L300-L400>) [crates/editor/src/element.rs2200-2400](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs#L2200-L2400>)

* * *

## Diff Operations

### Staging and Unstaging

Users can stage (add to index) or unstage hunks directly from the editor:


The staging process:

  1. Identify the hunk(s) to stage
  2. Generate a git patch for just those hunks
  3. Apply patch to index using `git apply --cached`
  4. Reload index text and recompute diff
  5. UI updates to reflect new staged state


Key actions:

  * `ToggleStaged`: Stage/unstage selected hunks
  * `StageAndNext`: Stage and navigate to next hunk
  * `UnstageAndNext`: Unstage and navigate to next hunk


Sources: [crates/editor/src/editor.rs8000-8200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L8000-L8200>) [crates/buffer_diff/src/buffer_diff.rs500-700](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L500-L700>) [crates/git/src/repository.rs500-600](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git/src/repository.rs#L500-L600>)

### Expanding and Collapsing

Diff hunks can be toggled between folded and unfolded states:

Action| Effect  
---|---  
`toggle_selected_diff_hunks()`| Toggle hunks at cursor  
`expand_all_diff_hunks()`| Expand all hunks in editor  
`collapse_all_diff_hunks()`| Collapse all hunks  
  
The toggle flow:

  1. Find `DisplayDiffHunk` at cursor position
  2. If `Folded`, expand it (load base text, compute display)
  3. If `Unfolded`, collapse it (remove expanded content)
  4. Update display map and repaint


Sources: [crates/editor/src/editor.rs7000-7300](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L7000-L7300>)

### Navigation

Users can jump between hunks:
    
    
    go_to_prev_hunk() -> Moves cursor to previous hunk
    go_to_next_hunk() -> Moves cursor to next hunk
    

Navigation works by:

  1. Finding current cursor position in multibuffer
  2. Querying `MultiBufferSnapshot::diff_hunks()` for adjacent hunks
  3. Moving selection to start/end of target hunk
  4. Scrolling to make hunk visible


Sources: [crates/editor/src/editor.rs9000-9200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L9000-L9200>)

* * *

## Project Diff View

`ProjectDiff` provides an aggregated view of all changes across a project:


Key features:

  1. **File Aggregation** : Combines diffs from multiple files into single editor
  2. **Excerpt Headers** : Shows file names between diff sections
  3. **Status Filtering** : Can filter by conflict/tracked/new files
  4. **Bulk Operations** : Stage/unstage all changes
  5. **Context Lines** : Shows surrounding lines for each hunk


The multibuffer construction:

  1. Get `GitStatus` from repository (all modified files)
  2. For each file, get or create `BufferDiff`
  3. Subscribe to diff changes
  4. Insert excerpts into `MultiBuffer` with context lines
  5. Sort by status (conflicts first, then tracked, then new)


Sources: [crates/git_ui/src/project_diff.rs64-202](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/project_diff.rs#L64-L202>) [crates/git_ui/src/project_diff.rs400-600](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/project_diff.rs#L400-L600>)

### Sorting and Organization

Files in `ProjectDiff` are sorted by status:


Within each category, files are sorted alphabetically by path.

Sources: [crates/git_ui/src/project_diff.rs84-86](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/project_diff.rs#L84-L86>)

* * *

## Integration with Display System

### DiffTransform in MultiBuffer

`MultiBuffer` uses `DiffTransform` to represent diff hunks in its text structure:


These transforms allow the multibuffer to:

  * Show inserted lines (new code)
  * Represent deleted lines (old code, not in buffer)
  * Filter diff content based on mode


The `DiffTransform` tree parallels the excerpt tree, allowing efficient coordinate mapping.

Sources: [crates/multi_buffer/src/multi_buffer.rs567-586](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L567-L586>)

### Coordinate Mapping

Diff hunks exist in multiple coordinate spaces:


Key mapping functions:

  * `MultiBufferSnapshot::diff_hunks()`: Returns hunks in multibuffer coordinates
  * `DisplaySnapshot::diff_hunks()`: Transforms to display coordinates
  * `EditorElement`: Maps display coordinates to screen pixels


Sources: [crates/multi_buffer/src/multi_buffer.rs1500-1600](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L1500-L1600>) [crates/editor/src/display_map.rs800-900](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/display_map.rs#L800-L900>)

* * *

## Remote Synchronization

### Protocol Messages

Diff state is synchronized in collaborative sessions:


The `UpdateDiffBases` message contains:


Sources: [crates/proto/proto/git.proto10-30](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/proto/git.proto#L10-L30>) [crates/project/src/git_store.rs1200-1400](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs#L1200-L1400>)

### Diff Sharing

For remote projects:

  1. **Host** computes diffs locally using its git repository
  2. Base texts (HEAD/index) are sent to **guests** via `UpdateDiffBases`
  3. **Guests** create `BufferDiff` entities with received base texts
  4. Each guest computes diff hunks independently
  5. Diff state is kept in sync as buffer edits occur


This allows guests to see diff indicators without needing git repository access.

Sources: [crates/project/src/git_store.rs1500-1700](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs#L1500-L1700>) [crates/collab/src/rpc.rs2000-2200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/collab/src/rpc.rs#L2000-L2200>)

* * *

## Performance Considerations

### Incremental Updates

The diff system optimizes performance through:

  1. **Debouncing** : Diff recalculation is debounced to avoid computing on every keystroke
  2. **Range Tracking** : Only affected ranges are recomputed, not entire file
  3. **Lazy Expansion** : Expanded hunk content is loaded on-demand
  4. **Background Tasks** : Diff computation happens off main thread


Sources: [crates/buffer_diff/src/buffer_diff.rs200-250](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L200-L250>) [crates/project/src/git_store.rs700-800](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs#L700-L800>)

### Caching

Base texts are cached:

  * `BufferGitState` stores `head_text` and `index_text` as `Arc<String>`
  * Text is reused across multiple diff computations
  * Only reloaded when hunk staging operations complete


Sources: [crates/project/src/git_store.rs115-137](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs#L115-L137>)

### Display Optimization

`EditorElement` rendering optimizes diff display:

  1. Only hunks in visible range are rendered
  2. Folded hunks use minimal screen space (just gutter indicator)
  3. Word diffs are computed lazily during rendering
  4. Gutter rendering is batched across multiple hunks


Sources: [crates/editor/src/element.rs1000-1200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs#L1000-L1200>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Diff System](<#diff-system>)
  * [Purpose and Scope](<#purpose-and-scope>)
  * [Architecture Overview](<#architecture-overview>)
  * [Diff Computation](<#diff-computation>)
  * [Base Text Loading](<#base-text-loading>)
  * [Diff Algorithm](<#diff-algorithm>)
  * [Diff Types](<#diff-types>)
  * [Diff Data Structures](<#diff-data-structures>)
  * [MultiBufferDiffHunk](<#multibufferdiffhunk>)
  * [DiffHunkStatus](<#diffhunkstatus>)
  * [DisplayDiffHunk](<#displaydiffhunk>)
  * [Diff Rendering](<#diff-rendering>)
  * [Gutter Indicators](<#gutter-indicators>)
  * [Expanded Hunks](<#expanded-hunks>)
  * [Word-Level Diffs](<#word-level-diffs>)
  * [Diff Operations](<#diff-operations>)
  * [Staging and Unstaging](<#staging-and-unstaging>)
  * [Expanding and Collapsing](<#expanding-and-collapsing>)
  * [Navigation](<#navigation>)
  * [Project Diff View](<#project-diff-view>)
  * [Sorting and Organization](<#sorting-and-organization>)
  * [Integration with Display System](<#integration-with-display-system>)
  * [DiffTransform in MultiBuffer](<#difftransform-in-multibuffer>)
  * [Coordinate Mapping](<#coordinate-mapping>)
  * [Remote Synchronization](<#remote-synchronization>)
  * [Protocol Messages](<#protocol-messages>)
  * [Diff Sharing](<#diff-sharing>)
  * [Performance Considerations](<#performance-considerations>)
  * [Incremental Updates](<#incremental-updates>)
  * [Caching](<#caching>)
  * [Display Optimization](<#display-optimization>)
