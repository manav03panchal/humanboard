<!-- Source: https://deepwiki.com/zed-industries/zed/2.6-focus-management-and-hit-testing -->

# 2.6 Focus Management And Hit Testing

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Focus Management and Hit Testing

Relevant source files

  * [crates/gpui/examples/mouse_pressure.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/examples/mouse_pressure.rs>)
  * [crates/gpui/src/app.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/app.rs>)
  * [crates/gpui/src/interactive.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/interactive.rs>)
  * [crates/gpui/src/key_dispatch.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/key_dispatch.rs>)
  * [crates/gpui/src/keymap.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/keymap.rs>)
  * [crates/gpui/src/platform.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform.rs>)
  * [crates/gpui/src/platform/linux/headless/client.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/linux/headless/client.rs>)
  * [crates/gpui/src/platform/linux/platform.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/linux/platform.rs>)
  * [crates/gpui/src/platform/linux/wayland/client.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/linux/wayland/client.rs>)
  * [crates/gpui/src/platform/linux/wayland/window.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/linux/wayland/window.rs>)
  * [crates/gpui/src/platform/linux/x11/client.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/linux/x11/client.rs>)
  * [crates/gpui/src/platform/linux/x11/window.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/linux/x11/window.rs>)
  * [crates/gpui/src/platform/mac/events.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/mac/events.rs>)
  * [crates/gpui/src/platform/mac/platform.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/mac/platform.rs>)
  * [crates/gpui/src/platform/mac/window.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/mac/window.rs>)
  * [crates/gpui/src/platform/test/platform.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/test/platform.rs>)
  * [crates/gpui/src/platform/test/window.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/test/window.rs>)
  * [crates/gpui/src/platform/windows/events.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/windows/events.rs>)
  * [crates/gpui/src/platform/windows/platform.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/windows/platform.rs>)
  * [crates/gpui/src/platform/windows/util.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/windows/util.rs>)
  * [crates/gpui/src/platform/windows/window.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/windows/window.rs>)
  * [crates/gpui/src/window.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs>)
  * [crates/ui/src/components/keybinding.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/ui/src/components/keybinding.rs>)


This page documents GPUI's focus management system, which tracks keyboard focus and enables context-aware action dispatch, and the hit testing system, which determines which UI elements should respond to mouse events. Together, these systems enable GPUI to route user input to the correct UI components.

For information about how actions are dispatched once focus is determined, see [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>). For details about the event flow leading to focus and hit testing, see [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>).

## Purpose and Scope

Focus management in GPUI determines which UI element receives keyboard input and provides context for action dispatch. Hit testing determines which UI elements are under the mouse cursor and should respond to mouse events. Both systems are fundamental to interactive UI behavior:

  * **Focus management** tracks a focus path from the focused element up through its ancestors, enabling hierarchical action dispatch
  * **Hit testing** identifies elements under the mouse, respecting occlusion rules and behaviors like scroll-only interaction
  * Both systems integrate with the dispatch tree to route events efficiently


## Focus System Architecture

### Core Focus Types

GPUI's focus system centers on three key types that work together to manage keyboard focus:


**FocusId** is a globally unique identifier created by the SlotMap, serving as a lightweight key. **FocusHandle** is a strong reference that keeps a focus target alive through reference counting. **WeakFocusHandle** allows checking if a focus target still exists without preventing its cleanup.

Sources: [crates/gpui/src/window.rs214-444](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L214-L444>)

### Focus Handle Lifecycle


The `FocusHandle` uses atomic reference counting to track when focus targets are still alive. When created via `Context::new_focus_handle()`, an entry is inserted into the shared `FocusMap` with a reference count of 1. Cloning increments the count atomically, and dropping decrements it.

Sources: [crates/gpui/src/window.rs290-409](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L290-L409>)

### Focus Paths and Containment

The dispatch tree maintains focus paths that enable hierarchical focus queries:


When a focus handle has focus, the dispatch tree stores the complete path from that element to the root. This enables three types of queries:

  * **`is_focused()`** \- Is this exact element focused?
  * **`contains_focused()`** \- Does this element contain the focused element?
  * **`within_focused()`** \- Is this element within the focused element?


Sources: [crates/gpui/src/window.rs243-271](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L243-L271>) [crates/gpui/src/window.rs807-811](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L807-L811>)

### Focus Events and Listeners

Focus changes trigger events that components can observe:

Event Type| Description| Registration Method  
---|---|---  
`WindowFocusEvent`| Fired when focus changes within a window| `Window::on_focus(listener)`  
`FocusOutEvent`| Fired when a specific element loses focus| `Context::on_focus_out(listener)`  
`FocusInEvent`| Detected via `is_focus_in()` on `WindowFocusEvent`| N/A - check in focus listener  
  

The `WindowFocusEvent` contains both the previous and current focus paths, allowing listeners to determine what changed. The helper methods `is_focus_in()` and `is_focus_out()` check if a specific `FocusId` is gaining or losing focus.

Sources: [crates/gpui/src/window.rs190-212](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L190-L212>) [crates/gpui/src/window.rs865-866](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L865-L866>)

### Tab Navigation

Focus handles support keyboard tab navigation through tab index and tab stop properties:

  * **tab_stop** : When `false`, element is excluded from tab navigation entirely
  * **tab_index** : Controls ordering; lower values (including negative) come first


The tab order is computed by the `TabStopMap` during rendering and accessed during tab key handling.

Sources: [crates/gpui/src/window.rs319-337](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L319-L337>)

## Hit Testing System

### Hitbox Core Concepts

The hit testing system determines which UI elements should respond to mouse events. Each interactive element registers a **hitbox** \- a rectangular region with associated behavior:


Each hitbox has:

  * **HitboxId** : Unique identifier for querying hover state
  * **Bounds** : The rectangular area
  * **ContentMask** : Clipping applied during painting
  * **Behavior** : Rules for blocking mouse events behind this hitbox


Sources: [crates/gpui/src/window.rs498-544](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L498-L544>)

### Hitbox Behaviors

GPUI defines three hitbox behaviors that control mouse event propagation:

Behavior| `is_hovered()`| `should_handle_scroll()`| Usage  
---|---|---|---  
`Normal`| If mouse inside| If mouse inside| Standard interactive elements  
`BlockMouse`| If mouse inside and not blocked| Never if blocked| Modal overlays, tooltips  
`BlockMouseExceptScroll`| Never if blocked| If mouse inside| Scrollable containers that block other interactions  
  

The distinction between `is_hovered()` and `should_handle_scroll()` is crucial:

  * **is_hovered()** : Used for clicks, moves, hover styles, tooltips
  * **should_handle_scroll()** : Used only for scroll wheel events


This allows elements like modal overlays to block mouse interaction while still allowing scrolling of underlying containers.

Sources: [crates/gpui/src/window.rs576-633](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L576-L633>)

### Hit Test Algorithm

The hit testing algorithm processes hitboxes from front to back (reverse order in the vector):


The `hover_hitbox_count` field marks the boundary: IDs before this index respond to all mouse events, while IDs after only respond to scroll events.

Sources: [crates/gpui/src/window.rs783-805](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L783-L805>)

### Mouse Event Routing

Hit test results determine which elements receive mouse events:


Mouse event handlers check `hitbox.is_hovered()` before processing most events, but scroll handlers check `hitbox.should_handle_scroll()` instead.

Sources: [crates/gpui/src/window.rs507-524](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L507-L524>)

## Tooltip System

Tooltips integrate with hit testing through a separate ID system:


Unlike hitboxes, tooltips use their own ID space and bounds checking. A tooltip is shown when the mouse hovers over its registered bounds for a duration.

Sources: [crates/gpui/src/window.rs636-662](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L636-L662>)

## Cursor Style Management

Cursor styles are managed through a priority system integrated with hit testing:


Global cursor style requests (without a hitbox) take precedence over hitbox-specific requests. Among hitbox requests, the last one (front-most) whose hitbox is hovered wins.

Sources: [crates/gpui/src/window.rs473-477](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L473-L477>) [crates/gpui/src/window.rs770-781](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L770-L781>)

## Integration with Event Dispatch

Focus and hit testing work together with the dispatch tree to route events:


**Keyboard events** are dispatched along the focus path from the focused element toward the root (bubble phase) or from root toward focused element (capture phase).

**Mouse events** are dispatched based on hit test results, with both capture (back to front) and bubble (front to back) phases.

Sources: [crates/gpui/src/window.rs71-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L71-L100>)

## Platform-Specific Implementations

### Windows Platform

Windows translates native events to GPUI input events through message handlers:

Windows Message| GPUI Event| Handler Function  
---|---|---  
`WM_MOUSEMOVE`| `MouseMoveEvent`| `handle_mouse_move_msg`  
`WM_LBUTTONDOWN`| `MouseDownEvent`| `handle_mouse_down_msg`  
`WM_KEYDOWN`| `KeyDownEvent`| `handle_keydown_msg`  
`WM_SETFOCUS`| Focus change| `handle_activate_msg`  
  
The Windows platform converts screen coordinates to client coordinates and applies DPI scaling before creating GPUI events.

Sources: [crates/gpui/src/platform/windows/events.rs35-116](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/windows/events.rs#L35-L116>)

### macOS Platform

macOS uses NSEvent objects that are converted to GPUI events:


The macOS implementation handles coordinate system differences (bottom-left origin vs. top-left) and extracts modifier key states from the event flags.

Sources: [crates/gpui/src/platform/mac/events.rs1-40](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/mac/events.rs#L1-L40>)

### Linux X11 Platform

X11 uses XInput2 events for precise device handling:


The X11 implementation tracks scroll axis valuators per device to calculate smooth scrolling deltas and uses XKB for keyboard layout translation.

Sources: [crates/gpui/src/platform/linux/x11/client.rs1-50](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/platform/linux/x11/client.rs#L1-L50>)

## Best Practices

### Focus Management

  1. **Create focus handles early** : Call `cx.new_focus_handle()` in your view's initialization
  2. **Track focus in elements** : Use `.track_focus(&focus_handle)` on your interactive elements
  3. **Check containment for hierarchical logic** : Use `contains_focused()` when parent elements need to know about child focus
  4. **Set tab properties appropriately** : Configure `tab_index` for custom ordering and `tab_stop` to exclude elements from tab navigation


### Hit Testing

  1. **Choose the right behavior** : 
     * Use `Normal` for most interactive elements
     * Use `BlockMouse` for modal overlays that should prevent all interaction behind them
     * Use `BlockMouseExceptScroll` for panels that block clicks but allow scrolling underneath
  2. **Check hover state correctly** : 
     * Use `is_hovered()` for clicks, moves, and hover styling
     * Use `should_handle_scroll()` only in scroll event handlers
  3. **Handle hitbox priority** : Remember that hitboxes are tested back-to-front, so later-painted elements take precedence


### Debugging

When troubleshooting focus or hit testing issues:

  1. **Verify focus registration** : Ensure your element calls `.track_focus()` during render
  2. **Check dispatch tree paths** : Focus containment queries depend on the dispatch tree structure
  3. **Inspect hitbox order** : Use the inspector (if enabled) to see hitbox boundaries and ordering
  4. **Test hitbox behavior** : Verify that `BlockMouse` vs `BlockMouseExceptScroll` matches your intent


Sources: [crates/gpui/src/window.rs1-2500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/gpui/src/window.rs#L1-L2500>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Focus Management and Hit Testing](<#focus-management-and-hit-testing>)
  * [Purpose and Scope](<#purpose-and-scope>)
  * [Focus System Architecture](<#focus-system-architecture>)
  * [Core Focus Types](<#core-focus-types>)
  * [Focus Handle Lifecycle](<#focus-handle-lifecycle>)
  * [Focus Paths and Containment](<#focus-paths-and-containment>)
  * [Focus Events and Listeners](<#focus-events-and-listeners>)
  * [Tab Navigation](<#tab-navigation>)
  * [Hit Testing System](<#hit-testing-system>)
  * [Hitbox Core Concepts](<#hitbox-core-concepts>)
  * [Hitbox Behaviors](<#hitbox-behaviors>)
  * [Hit Test Algorithm](<#hit-test-algorithm>)
  * [Mouse Event Routing](<#mouse-event-routing>)
  * [Tooltip System](<#tooltip-system>)
  * [Cursor Style Management](<#cursor-style-management>)
  * [Integration with Event Dispatch](<#integration-with-event-dispatch>)
  * [Platform-Specific Implementations](<#platform-specific-implementations>)
  * [Windows Platform](<#windows-platform>)
  * [macOS Platform](<#macos-platform>)
  * [Linux X11 Platform](<#linux-x11-platform>)
  * [Best Practices](<#best-practices>)
  * [Focus Management](<#focus-management>)
  * [Hit Testing](<#hit-testing>)
  * [Debugging](<#debugging>)
