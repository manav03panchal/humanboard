<!-- Source: https://deepwiki.com/zed-industries/zed/3.6-diff-integration -->

# 3.6 Diff Integration

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Diff Integration

Relevant source files

  * [crates/buffer_diff/src/buffer_diff.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs>)
  * [crates/collab/src/rpc.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/collab/src/rpc.rs>)
  * [crates/editor/src/actions.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/actions.rs>)
  * [crates/editor/src/code_completion_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/code_completion_tests.rs>)
  * [crates/editor/src/code_context_menus.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/code_context_menus.rs>)
  * [crates/editor/src/editor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs>)
  * [crates/editor/src/editor_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_tests.rs>)
  * [crates/editor/src/element.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs>)
  * [crates/fs/src/fake_git_repo.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/fs/src/fake_git_repo.rs>)
  * [crates/git/src/git.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git/src/git.rs>)
  * [crates/git/src/repository.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git/src/repository.rs>)
  * [crates/git_ui/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/Cargo.toml>)
  * [crates/git_ui/src/branch_picker.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/branch_picker.rs>)
  * [crates/git_ui/src/commit_modal.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/commit_modal.rs>)
  * [crates/git_ui/src/git_panel.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/git_panel.rs>)
  * [crates/git_ui/src/git_ui.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/git_ui.rs>)
  * [crates/git_ui/src/project_diff.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/project_diff.rs>)
  * [crates/language/src/buffer.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs>)
  * [crates/language/src/buffer_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer_tests.rs>)
  * [crates/language/src/syntax_map.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/syntax_map.rs>)
  * [crates/multi_buffer/src/anchor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/anchor.rs>)
  * [crates/multi_buffer/src/multi_buffer.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs>)
  * [crates/multi_buffer/src/multi_buffer_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer_tests.rs>)
  * [crates/project/src/git_store.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/git_store.rs>)
  * [crates/proto/proto/git.proto](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/proto/git.proto>)
  * [crates/proto/proto/zed.proto](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/proto/zed.proto>)
  * [crates/proto/src/proto.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/proto/src/proto.rs>)


## Purpose and Scope

This page documents how git diffs are integrated into the Editor, including the visualization of diff hunks in the gutter and text area, hunk expansion and collapse, and interactive staging/unstaging operations. It covers the data flow from git repository state through the diff computation layer to editor rendering.

For information about the broader git integration system, see the Git Integration section (page 8). For details on the MultiBuffer system that coordinates diffs across multiple excerpts, see [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>). For the standalone diff view UI, see the Git UI documentation.

## Architecture Overview

The diff integration system connects git repository state to editor visualization through several layers:


Sources: [crates/editor/src/editor.rs1-300](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L1-L300>) [crates/multi_buffer/src/multi_buffer.rs1-200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L1-L200>) [crates/buffer_diff/src/buffer_diff.rs1-50](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L1-L50>)

### Component Responsibilities

Component| Responsibility  
---|---  
`BufferDiff`| Computes diffs between git HEAD, index, and working tree using libgit2  
`MultiBuffer`| Exposes diffs in multi-buffer coordinate system via `MultiBufferDiffHunk`  
`Editor`| Maintains `DisplayDiffHunk` state for visible hunks and handles user interactions  
`EditorElement`| Renders diff indicators in gutter and inline, with optional staging controls  
  
Sources: [crates/buffer_diff/src/buffer_diff.rs1-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L1-L100>) [crates/multi_buffer/src/multi_buffer.rs141-186](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L141-L186>) [crates/editor/src/editor.rs306-318](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L306-L318>)

## Diff Hunk Data Structures

### DiffHunkStatus

The status of a diff hunk indicates what type of change it represents and whether it also appears in a secondary diff (e.g., staged changes):


Sources: [crates/buffer_diff/src/buffer_diff.rs1-50](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L1-L50>)

### MultiBufferDiffHunk

The `MultiBufferDiffHunk` represents a diff hunk in multi-buffer coordinates, bridging the gap between buffer-local positions and editor-visible positions:


Key methods on `MultiBufferDiffHunk`:

  * `status()` \- Computes `DiffHunkStatus` from buffer and base ranges
  * `is_created_file()` \- Checks if this represents a newly created file
  * `multi_buffer_range()` \- Returns the hunk range as multi-buffer `Anchor`s


Sources: [crates/multi_buffer/src/multi_buffer.rs141-186](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L141-L186>)

### DisplayDiffHunk

The `DisplayDiffHunk` enum represents diff hunks in the editor's display coordinate system, with support for folded (collapsed) and unfolded (expanded) states:


The editor maintains a list of `DisplayDiffHunk`s that are currently visible or near the viewport, converting from `MultiBufferDiffHunk`s as needed.

Sources: [crates/editor/src/editor.rs306-318](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L306-L318>)

## Diff Visualization in the Editor

### Gutter Indicators

Diff hunks are visualized in the editor gutter with color-coded indicators:


The gutter rendering logic in `EditorElement`:

  * Computes which display rows contain diff hunks
  * Renders a vertical bar in the gutter for added/modified lines
  * Renders a deletion indicator for deleted line ranges
  * Applies theming based on `DiffHunkStatus`


Sources: [crates/editor/src/element.rs1-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs#L1-L100>)

### Word-Level Diffs

Within modified hunks, individual words that changed are highlighted with a different background color. The `word_diffs` field contains the byte ranges of changed words:


These ranges are computed by the `BufferDiff` using git's word diff algorithm and converted to multi-buffer offsets.

Sources: [crates/buffer_diff/src/buffer_diff.rs100-200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L100-L200>) [crates/editor/src/element.rs2000-2500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs#L2000-L2500>)

### Hunk Controls Rendering

When `show_git_diff_gutter` is enabled and `RenderDiffHunkControlsFn` is set, the editor displays interactive controls for staging/unstaging hunks:


The controls typically include:

  * Stage/unstage buttons for working tree diffs
  * Expand/collapse buttons for folded hunks
  * Visual indicators of staging status


Sources: [crates/editor/src/editor.rs247-258](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L247-L258>)

## Interactive Diff Operations

### Staging and Unstaging Hunks

The editor provides actions to stage or unstage selected diff hunks:


Key actions:

  * `toggle_selected_diff_hunks` \- Stage/unstage hunks at cursor positions
  * `toggle_staged_selected_diff_hunks` \- Toggle staging status
  * `stage_and_next` \- Stage current hunk and jump to next
  * `unstage_and_next` \- Unstage current hunk and jump to next


Sources: [crates/editor/src/editor.rs500-510](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L500-L510>) [crates/editor/src/git.rs1-500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/git.rs#L1-L500>)

### Hunk Expansion and Collapse

Diff hunks can be expanded to show the full diff context or collapsed to save screen space:

Action| Behavior  
---|---  
`expand_all_diff_hunks`| Expands all collapsed hunks in the buffer  
`collapse_all_diff_hunks`| Collapses all expanded hunks  
`ToggleFold` (on diff hunk)| Toggles individual hunk expansion  
  
When a hunk is expanded (transitioned from `DisplayDiffHunk::Folded` to `DisplayDiffHunk::Unfolded`):

  1. The editor requests the full hunk content from `BufferDiff`
  2. Word-level diffs are computed and cached
  3. The display is updated to show the full hunk with inline diff highlighting


Sources: [crates/editor/src/editor.rs507-508](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L507-L508>) [crates/editor/src/element.rs1-500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs#L1-L500>)

### Navigation Between Hunks

The editor provides navigation actions to jump between diff hunks:


These actions:

  1. Query the `MultiBuffer` for diff hunks after/before the current cursor position
  2. Move the cursor to the start of the target hunk
  3. Optionally auto-scroll to ensure the hunk is visible


Sources: [crates/editor/src/editor.rs400-401](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L400-L401>)

## Integration with MultiBuffer

The diff integration must handle the complexity of excerpts in a `MultiBuffer`. Each excerpt can have its own set of diff hunks:


The coordinate transformation:

  1. `BufferDiff` operates in buffer coordinates (`text::Anchor`, `BufferOffset`)
  2. `MultiBuffer` maps these to multi-buffer coordinates (`Anchor`, `MultiBufferOffset`)
  3. `Editor` converts to display coordinates (`DisplayPoint`, `DisplayRow`)
  4. `EditorElement` renders in pixel coordinates


Sources: [crates/multi_buffer/src/multi_buffer.rs1-600](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L1-L600>) [crates/editor/src/display_map/display_map.rs1-500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/display_map/display_map.rs#L1-L500>)

### Diff Filtering in MultiBuffers

The `MultiBuffer` can be configured to filter diff content using `MultiBufferFilterMode`:


This is used by the `ProjectDiff` view to show only relevant changes in different panes (e.g., one pane with deletions, one with additions).

Sources: [crates/multi_buffer/src/multi_buffer.rs100-104](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L100-L104>) [crates/git_ui/src/project_diff.rs64-200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/git_ui/src/project_diff.rs#L64-L200>)

## Diff Update Flow

Changes to the git repository or buffer content trigger diff recalculation:


The `BufferDiff` recalculation is debounced to avoid excessive computation. When changes occur:

  1. A background task reads HEAD and index content from git
  2. The diff is computed using libgit2's diff algorithm
  3. Word-level diffs are computed for modified hunks
  4. Events are emitted to update subscribers


Sources: [crates/buffer_diff/src/buffer_diff.rs200-500](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs#L200-L500>) [crates/multi_buffer/src/multi_buffer.rs528-543](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs#L528-L543>) [crates/editor/src/editor.rs1-300](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L1-L300>)

## Configuration and Settings

Diff visualization is controlled by several editor settings:

Setting| Type| Default| Description  
---|---|---|---  
`show_git_diff_gutter`| `Option<bool>`| `None` (inherited)| Whether to show diff indicators in gutter  
`git_gutter`| `GitGutterSetting`| Varies| Overall git gutter visibility setting  
`all_diff_hunks_expanded`| `bool`| `false`| Whether hunks start expanded or collapsed  
  
The `GitGutterSetting` enum (from settings crate) provides system-level control:

  * `TrackedFiles` \- Show diffs only for tracked files
  * `Hide` \- Never show diff gutter
  * (Default behavior varies by file type)


Sources: [crates/editor/src/editor.rs1079](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs#L1079-L1079>) [crates/editor/src/editor_settings.rs1-200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_settings.rs#L1-L200>) [crates/settings/src/settings.rs1-200](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings.rs#L1-L200>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Diff Integration](<#diff-integration>)
  * [Purpose and Scope](<#purpose-and-scope>)
  * [Architecture Overview](<#architecture-overview>)
  * [Component Responsibilities](<#component-responsibilities>)
  * [Diff Hunk Data Structures](<#diff-hunk-data-structures>)
  * [DiffHunkStatus](<#diffhunkstatus>)
  * [MultiBufferDiffHunk](<#multibufferdiffhunk>)
  * [DisplayDiffHunk](<#displaydiffhunk>)
  * [Diff Visualization in the Editor](<#diff-visualization-in-the-editor>)
  * [Gutter Indicators](<#gutter-indicators>)
  * [Word-Level Diffs](<#word-level-diffs>)
  * [Hunk Controls Rendering](<#hunk-controls-rendering>)
  * [Interactive Diff Operations](<#interactive-diff-operations>)
  * [Staging and Unstaging Hunks](<#staging-and-unstaging-hunks>)
  * [Hunk Expansion and Collapse](<#hunk-expansion-and-collapse>)
  * [Navigation Between Hunks](<#navigation-between-hunks>)
  * [Integration with MultiBuffer](<#integration-with-multibuffer>)
  * [Diff Filtering in MultiBuffers](<#diff-filtering-in-multibuffers>)
  * [Diff Update Flow](<#diff-update-flow>)
  * [Configuration and Settings](<#configuration-and-settings>)
