<!-- Source: https://deepwiki.com/zed-industries/zed/11.6-legacy-agent-thread-system -->

# 11.6 Legacy Agent Thread System

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Legacy Agent Thread System

Relevant source files

  * [crates/agent/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/Cargo.toml>)
  * [crates/agent/src/thread.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs>)
  * [crates/eval/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/eval/Cargo.toml>)
  * [crates/eval/src/eval.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/eval/src/eval.rs>)
  * [crates/eval/src/example.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/eval/src/example.rs>)


## Purpose and Scope

This page documents the **Legacy Agent Thread System** , which is the original implementation of agent conversations in Zed before the introduction of the Agent Communication Protocol (ACP). This system is primarily implemented in the `Thread` entity and provides direct integration with language models and tools without an intermediary protocol layer.

For information about the newer ACP-based agent system, see [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>), [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>), and [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>). The legacy system documented here is still used in evaluation frameworks and serves as a reference implementation.

**Sources:** [crates/agent/src/thread.rs1-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L1-L100>)

* * *

## Thread Entity Overview

The `Thread` entity is the central coordinator for agent conversations in the legacy system. It manages message history, language model interactions, tool execution, and state persistence.


**Key Responsibilities:**

Responsibility| Implementation  
---|---  
Message History| `messages: Vec<Message>` stores all conversation turns  
Language Model| `model: Option<Arc<dyn LanguageModel>>` manages model selection  
Tool Execution| `tools: BTreeMap` registry of available agent tools  
Project Context| `project: Entity<Project>` provides file system access  
Change Tracking| `action_log: Entity<ActionLog>` records agent modifications  
Turn Management| `running_turn: Option<RunningTurn>` handles active requests  
  
**Sources:** [crates/agent/src/thread.rs583-618](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L583-L618>)

* * *

## Message Types and Structure

### Message Enum

The `Message` enum represents all message types in a conversation thread:


**Sources:** [crates/agent/src/thread.rs93-135](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L93-L135>)

### UserMessage Structure

User messages contain text, mentions, and images:


The `to_request()` method transforms user messages into structured context for the language model, organizing mentions into tagged sections:

Tag| Content Type| Purpose  
---|---|---  
`<files>`| File mentions| Full file contents with paths  
`<directories>`| Directory mentions| Directory listings  
`<symbols>`| Symbol mentions| Code symbol definitions  
`<selections>`| Selection mentions| Selected text ranges  
`<threads>`| Thread mentions| Referenced conversation threads  
`<fetched_urls>`| Fetch mentions| Fetched web content  
`<rules>`| Rule mentions| Custom user rules  
  
**Sources:** [crates/agent/src/thread.rs137-357](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L137-L357>)

### AgentMessage Structure

Agent messages contain text, thinking blocks, and tool uses:


**Sources:** [crates/agent/src/thread.rs511-527](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L511-L527>) [crates/agent/src/thread.rs379-509](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L379-L509>)

* * *

## Thread Lifecycle and Operations

### Thread Creation


**New Thread Creation:**

  * Creates new `SessionId` using UUID
  * Initializes empty message history
  * Sets up prompt capabilities channel
  * Creates action log for tracking changes
  * Loads default agent profile


**Sources:** [crates/agent/src/thread.rs620-675](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L620-L675>)

### Thread from Database


**Restoration Process:**

  * Loads persisted messages from `DbThread`
  * Restores model selection or falls back to default
  * Loads token usage statistics
  * Restores initial project snapshot


**Sources:** [crates/agent/src/thread.rs788-863](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L788-L863>)

* * *

## Message Flow and Request Handling

### Sending User Messages


The `send()` method initiates a new conversation turn:

  1. **Message Creation:** Constructs `UserMessage` with provided content
  2. **History Update:** Appends message to thread history
  3. **Turn Initiation:** Calls `start_turn()` to begin LM interaction
  4. **Event Streaming:** Returns `UnboundedReceiver<ThreadEvent>` for updates


**Sources:** [crates/agent/src/thread.rs1076-1111](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L1076-L1111>)

### Turn Execution

The `start_turn()` method manages the complete agent interaction cycle:


**Key Steps:**

Step| Implementation| Location  
---|---|---  
**Context Building**|  Converts messages to `LanguageModelRequest`| [thread.rs1150-1200](<https://github.com/zed-industries/zed/blob/4109c9dd/thread.rs#L1150-L1200>)  
**System Prompt**|  Adds template-based system instructions| [thread.rs1201-1250](<https://github.com/zed-industries/zed/blob/4109c9dd/thread.rs#L1201-L1250>)  
**Tool Registration**|  Provides tool schemas to model| [thread.rs1251-1300](<https://github.com/zed-industries/zed/blob/4109c9dd/thread.rs#L1251-L1300>)  
**Event Processing**|  Handles streaming completion events| [thread.rs1350-1550](<https://github.com/zed-industries/zed/blob/4109c9dd/thread.rs#L1350-L1550>)  
**Tool Execution**|  Invokes tools and collects results| [thread.rs1800-1900](<https://github.com/zed-industries/zed/blob/4109c9dd/thread.rs#L1800-L1900>)  
**Error Handling**|  Implements retry logic for failures| [thread.rs1950-2050](<https://github.com/zed-industries/zed/blob/4109c9dd/thread.rs#L1950-L2050>)  
  
**Sources:** [crates/agent/src/thread.rs1113-1381](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L1113-L1381>)

* * *

## Tool Integration

### Tool Registration

The thread maintains a registry of available tools:


**Default Tools Added:**

The `add_default_tools()` method registers the standard tool set:

  * **File Operations:** `ReadFileTool`, `EditFileTool`, `CreateDirectoryTool`, `DeletePathTool`, `CopyPathTool`, `MovePathTool`
  * **Search & Navigation:** `FindPathTool`, `GrepTool`, `ListDirectoryTool`, `OpenTool`
  * **Code Intelligence:** `DiagnosticsTool`
  * **Execution:** `TerminalTool`
  * **Network:** `FetchTool`, `WebSearchTool`
  * **Utility:** `ThinkingTool`, `NowTool`


**Sources:** [crates/agent/src/thread.rs974-1008](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L974-L1008>)

### Tool Execution Flow


**Tool Execution Process:**

  1. **Tool Lookup:** Finds tool implementation by name in `tools` BTreeMap
  2. **Authorization:** Some tools require user approval (destructive operations)
  3. **Invocation:** Calls `Tool::execute()` with parsed input
  4. **Progress Updates:** Tool emits events through event stream
  5. **Result Storage:** Stores result in `AgentMessage.tool_results`
  6. **Continuation:** Includes result in next LM request


**Sources:** [crates/agent/src/thread.rs1799-1901](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L1799-L1901>)

* * *

## Thread Event System

### ThreadEvent Types

The `ThreadEvent` enum provides updates during thread execution:


**Event Flow:**

Event| When Emitted| Purpose  
---|---|---  
`UserMessage`| User sends message| Broadcasts user input  
`AgentText`| Model generates text| Streams response content  
`AgentThinking`| Model generates thinking| Streams internal reasoning  
`ToolCall`| Tool execution begins| Announces tool invocation  
`ToolCallUpdate`| Tool progress/completion| Updates tool status  
`ToolCallAuthorization`| Permission needed| Requests user approval  
`Retry`| Request retry| Indicates retry attempt  
`Stop`| Turn completes| Signals completion/error  
  
**Sources:** [crates/agent/src/thread.rs546-576](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L546-L576>)

### Event Streaming Implementation

The thread uses `ThreadEventStream` to emit events:


The stream provides methods for emitting typed events:

  * `send_text()` \- Emits agent text content
  * `send_thinking()` \- Emits thinking blocks
  * `send_tool_call()` \- Announces tool execution
  * `update_tool_call_fields()` \- Updates tool status
  * `send_user_message()` \- Broadcasts user messages


**Sources:** [crates/agent/src/thread.rs2236-2357](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L2236-L2357>)

* * *

## Thread Replay Functionality

The `replay()` method reconstructs the thread's event stream from stored messages:


**Replay Process:**

  1. **Message Iteration:** Walks through stored `messages` vector
  2. **Event Reconstruction:** Emits appropriate `ThreadEvent` for each message part
  3. **Tool Replay:** Calls `Tool::replay()` to reconstruct tool execution display
  4. **Status Restoration:** Sets final tool status (Completed/Failed)


This enables UI components to display thread history without re-executing actions.

**Sources:** [crates/agent/src/thread.rs681-713](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L681-L713>) [crates/agent/src/thread.rs715-786](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L715-L786>)

* * *

## State Persistence

### Database Serialization

The `to_db()` method converts thread state to `DbThread`:


**Persisted Fields:**

Field| Type| Purpose  
---|---|---  
`title`| `SharedString`| Thread title (auto-generated or user-set)  
`messages`| `Vec<Message>`| Complete message history  
`updated_at`| `DateTime<Utc>`| Last modification timestamp  
`detailed_summary`| `Option<SharedString>`| AI-generated summary  
`initial_project_snapshot`| `Option<Arc<ProjectSnapshot>>`| Initial project state  
`cumulative_token_usage`| `TokenUsage`| Total tokens consumed  
`request_token_usage`| `HashMap`| Per-message token usage  
`model`| `DbLanguageModel`| Model provider and name  
`completion_mode`| `CompletionMode`| Stream vs batch mode  
`profile`| `AgentProfileId`| Agent profile used  
  
**Sources:** [crates/agent/src/thread.rs865-888](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L865-L888>)

* * *

## Model and Profile Management

### Model Selection


The thread manages model selection and capabilities:

  * **Model Storage:** `model: Option<Arc<dyn LanguageModel>>`
  * **Capability Tracking:** `prompt_capabilities_rx` broadcasts model features (image support, etc.)
  * **Usage Updates:** Recalculates token limits when model changes


**Sources:** [crates/agent/src/thread.rs922-936](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L922-L936>)

### Profile Management

Agent profiles control model selection, system prompts, and tool availability:


The `set_profile()` method switches profiles and updates model:

  1. **Profile Switch:** Updates `profile_id` field
  2. **Model Resolution:** Resolves profile's preferred model
  3. **Tool Refresh:** May enable/disable profile-specific tools


**Sources:** [crates/agent/src/thread.rs1018-1052](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L1018-L1052>)

* * *

## Token Usage Tracking

### Usage Accumulation


**Token Tracking:**

  * **Per-Message Usage:** Maps `UserMessageId` to token counts for that turn
  * **Cumulative Total:** Maintains running total across thread lifetime
  * **Cache Metrics:** Tracks prompt caching efficiency (creation vs read)
  * **Usage Events:** Emits `TokenUsageUpdated` when usage changes


**Sources:** [crates/agent/src/thread.rs3079-3110](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L3079-L3110>)

### Latest Usage Calculation

The `latest_token_usage()` method computes current token consumption:


Returns `Option<RequestUsage>` with:

  * **Model Limits:** Max input/output tokens from model
  * **Used Tokens:** From last user message request
  * **Remaining:** Calculated based on mode (stream/batch) limits


**Sources:** [crates/agent/src/thread.rs3112-3162](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L3112-L3162>)

* * *

## Relationship to ACP-Based System

The legacy `Thread` system differs from the newer ACP-based architecture in several key ways:

Aspect| Legacy Thread| ACP System  
---|---|---  
**Protocol**|  Direct language model calls| Stdio-based Agent Communication Protocol  
**Message Format**|  Internal `Message` enum| ACP protocol messages  
**Tool Execution**|  Inline in thread| Delegated to agent server  
**Event Stream**| `ThreadEvent` enum| ACP protocol events  
**Persistence**|  Direct database serialization| Protocol-agnostic storage  
**Agent Implementation**|  Single integrated implementation| Pluggable agent servers  
  
**Migration Path:**

The ACP-based system (sections 11.1-11.5) provides:

  * **Protocol Abstraction:** Standardized communication layer
  * **Agent Diversity:** Multiple agent implementations (Claude, Gemini, custom)
  * **Better Testing:** Agent servers can be tested independently
  * **Enhanced Tooling:** Context servers extend tool capabilities


The legacy `Thread` system remains in use for:

  * **Evaluation Framework:** `crates/eval` uses `Thread` directly
  * **Testing:** Unit tests against `Thread` implementation
  * **Reference Implementation:** Documents core agent behavior


**Sources:** [crates/agent/src/thread.rs1-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/agent/src/thread.rs#L1-L100>) [crates/eval/src/example.rs1-100](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/eval/src/example.rs#L1-L100>)

* * *

## Usage in Evaluation Framework

The eval crate demonstrates legacy thread usage:


**Evaluation Flow:**

  1. **Thread Creation:** Creates `Thread` with test project
  2. **Message Sending:** Calls `thread.send()` with user prompt
  3. **Event Processing:** Consumes `ThreadEvent` stream
  4. **Assertion Checking:** Validates tool calls and responses
  5. **Metrics Collection:** Tracks tool success/failure rates


**Key Evaluation Methods:**

  * `prompt(message)` \- Sends message and waits for completion
  * `prompt_with_max_turns()` \- Limits tool execution rounds
  * `proceed_with_max_turns()` \- Continues without new user message
  * `edits()` \- Retrieves file modifications from action log


**Sources:** [crates/eval/src/example.rs91-393](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/eval/src/example.rs#L91-L393>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Legacy Agent Thread System](<#legacy-agent-thread-system>)
  * [Purpose and Scope](<#purpose-and-scope>)
  * [Thread Entity Overview](<#thread-entity-overview>)
  * [Message Types and Structure](<#message-types-and-structure>)
  * [Message Enum](<#message-enum>)
  * [UserMessage Structure](<#usermessage-structure>)
  * [AgentMessage Structure](<#agentmessage-structure>)
  * [Thread Lifecycle and Operations](<#thread-lifecycle-and-operations>)
  * [Thread Creation](<#thread-creation>)
  * [Thread from Database](<#thread-from-database>)
  * [Message Flow and Request Handling](<#message-flow-and-request-handling>)
  * [Sending User Messages](<#sending-user-messages>)
  * [Turn Execution](<#turn-execution>)
  * [Tool Integration](<#tool-integration>)
  * [Tool Registration](<#tool-registration>)
  * [Tool Execution Flow](<#tool-execution-flow>)
  * [Thread Event System](<#thread-event-system>)
  * [ThreadEvent Types](<#threadevent-types>)
  * [Event Streaming Implementation](<#event-streaming-implementation>)
  * [Thread Replay Functionality](<#thread-replay-functionality>)
  * [State Persistence](<#state-persistence>)
  * [Database Serialization](<#database-serialization>)
  * [Model and Profile Management](<#model-and-profile-management>)
  * [Model Selection](<#model-selection>)
  * [Profile Management](<#profile-management>)
  * [Token Usage Tracking](<#token-usage-tracking>)
  * [Usage Accumulation](<#usage-accumulation>)
  * [Latest Usage Calculation](<#latest-usage-calculation>)
  * [Relationship to ACP-Based System](<#relationship-to-acp-based-system>)
  * [Usage in Evaluation Framework](<#usage-in-evaluation-framework>)
