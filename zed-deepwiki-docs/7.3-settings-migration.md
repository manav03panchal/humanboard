<!-- Source: https://deepwiki.com/zed-industries/zed/7.3-settings-migration -->

# 7.3 Settings Migration

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# Settings Migration

Relevant source files

  * [assets/settings/default.json](<https://github.com/zed-industries/zed/blob/4109c9dd/assets/settings/default.json>)
  * [crates/editor/src/editor_settings.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_settings.rs>)
  * [crates/language/src/language_settings.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/language_settings.rs>)
  * [crates/migrator/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/Cargo.toml>)
  * [crates/migrator/src/migrations.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrations.rs>)
  * [crates/migrator/src/migrator.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs>)
  * [crates/project/src/project_settings.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/project/src/project_settings.rs>)
  * [crates/settings/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/Cargo.toml>)
  * [crates/settings/src/keymap_file.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/keymap_file.rs>)
  * [crates/settings/src/settings.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings.rs>)
  * [crates/settings/src/settings_content.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_content.rs>)
  * [crates/settings/src/settings_content/editor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_content/editor.rs>)
  * [crates/settings/src/settings_content/language.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_content/language.rs>)
  * [crates/settings/src/settings_content/project.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_content/project.rs>)
  * [crates/settings/src/settings_content/terminal.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_content/terminal.rs>)
  * [crates/settings/src/settings_content/workspace.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_content/workspace.rs>)
  * [crates/settings/src/settings_store.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs>)
  * [crates/settings/src/vscode_import.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/vscode_import.rs>)
  * [crates/settings_ui/Cargo.toml](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings_ui/Cargo.toml>)
  * [crates/settings_ui/src/page_data.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings_ui/src/page_data.rs>)
  * [crates/settings_ui/src/settings_ui.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings_ui/src/settings_ui.rs>)
  * [crates/terminal/src/terminal_settings.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/terminal/src/terminal_settings.rs>)
  * [crates/worktree/src/worktree_settings.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/worktree/src/worktree_settings.rs>)
  * [crates/zed/src/zed/migrate.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/zed/src/zed/migrate.rs>)
  * [docs/src/configuring-zed.md](<https://github.com/zed-industries/zed/blob/4109c9dd/docs/src/configuring-zed.md>)
  * [docs/src/visual-customization.md](<https://github.com/zed-industries/zed/blob/4109c9dd/docs/src/visual-customization.md>)


## Purpose and Scope

Settings Migration is Zed's system for automatically updating user configuration files (settings.json and keymap.json) when the format or naming of settings and keybindings change between versions. This ensures that users' configurations continue to work correctly after upgrades, without requiring manual intervention.

This document covers the migration architecture, how migrations are executed, and how to create new migrations. For information about the settings system itself, see [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>). For keymap configuration, see [Keymap System](</zed-industries/zed/7.4-keymap-system>).

## Migration System Overview

The migration system consists of three main components:

  1. **Migrator** : Core migration engine that transforms configuration text using tree-sitter queries or JSON transformations
  2. **Migration Status Tracking** : System for tracking whether migrations have been attempted and whether they succeeded
  3. **Migration UI** : Banner component that prompts users to apply migrations


The system supports two types of migrations:

  * **TreeSitter-based migrations** : Use tree-sitter queries to identify and replace patterns in JSON text
  * **JSON-based migrations** : Parse JSON, transform the value tree, and write it back


Sources: [crates/migrator/src/migrator.rs1-248](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L1-L248>) [crates/settings/src/settings_store.rs763-802](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L763-L802>)

## Architecture Components


Sources: [crates/migrator/src/migrator.rs1-248](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L1-L248>) [crates/settings/src/settings_store.rs141-802](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L141-L802>) [crates/zed/src/zed/migrate.rs1-305](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/zed/src/zed/migrate.rs#L1-L305>)

## Core Migration Types

### MigrationType Enum

The migration system uses an enum to represent different migration strategies:


**TreeSitter Migrations** use tree-sitter queries to identify patterns in JSON text and replace them. This approach preserves comments and formatting while allowing pattern-based transformations.

**JSON Migrations** parse the entire JSON structure, apply transformations to the value tree, and write it back. This is useful for complex structural changes like moving nested values or flattening objects.

Sources: [crates/migrator/src/migrator.rs150-153](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L150-L153>) [crates/migrator/src/migrator.rs28-67](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L28-L67>) [crates/migrator/src/migrator.rs82-110](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L82-L110>)

## Migration Status Tracking


The `MigrationStatus` enum tracks the state of migration attempts for each configuration file:

Status| Description  
---|---  
`NotAttempted`| Initial state; no migration check performed yet  
`ShouldAttempt { can_migrate: bool }`| Old format detected; `can_migrate` indicates if migration is possible  
`Attempted`| User dismissed the migration banner without migrating  
`Failed(error_message)`| Migration was attempted but encountered an error  
  
Migration status is stored per file type (user settings, keymap) and persists in the `SettingsStore`. The status is checked on startup and when files are reloaded.

Sources: [crates/settings/src/settings_store.rs763-802](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L763-L802>) [crates/settings/src/settings_store.rs846-906](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L846-L906>)

## Migration Workflow


The migration workflow follows these steps:

  1. **Detection** : When `SettingsStore` loads a configuration file, it passes the contents to the migrator
  2. **Analysis** : The migrator runs all migrations and returns `Some(new_text)` if changes were made, or `None` if no migration needed
  3. **Status Update** : If changes are possible, the store sets `migration_status` to `ShouldAttempt` with `can_migrate: true`
  4. **UI Notification** : `MigrationBanner` displays in the toolbar when migration is possible
  5. **User Action** : User can click "Migrate" to apply changes, or dismiss the banner
  6. **Application** : If user migrates, the new contents are written to disk and status is reset


Sources: [crates/migrator/src/migrator.rs69-118](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L69-L118>) [crates/settings/src/settings_store.rs846-906](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L846-L906>) [crates/zed/src/zed/migrate.rs100-210](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/zed/src/zed/migrate.rs#L100-L210>)

## TreeSitter-Based Migrations

### Migration Pattern Structure

TreeSitter migrations use patterns defined as tuples of pattern index and callback function:


Each migration pattern:

  1. Identifies a specific pattern index in a tree-sitter query
  2. Provides a callback that receives the matched text and returns replacement edits
  3. Returns a list of `(Range, String)` tuples indicating what to replace and with what


The migration engine:

  * Parses the JSON text using tree-sitter
  * Runs the query to find all matches
  * Invokes callbacks for each match to generate edits
  * Sorts and deduplicates edits to avoid conflicts
  * Applies edits in reverse order to preserve offsets


Sources: [crates/migrator/src/migrator.rs23-26](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L23-L26>) [crates/migrator/src/migrator.rs28-67](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L28-L67>)

### Example Migration Flow


Sources: [crates/migrator/src/migrator.rs28-67](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L28-L67>)

## JSON-Based Migrations

JSON-based migrations work with the parsed value tree:

  1. **Parse** : Use `parse_json_with_comments()` to parse the JSON text into a `serde_json::Value`
  2. **Transform** : Callback function modifies the value tree (e.g., moving, renaming, or restructuring fields)
  3. **Diff** : `update_value_in_json_text()` compares old and new value trees to generate minimal edits
  4. **Apply** : Edits are applied to preserve formatting and comments


This approach is used for complex structural changes like:

  * Flattening nested objects (`flatten_code_actions_formatters`)
  * Removing deprecated fields (`remove_formatters_on_save`)
  * Converting between types (`make_file_finder_include_ignored_an_enum`)


Sources: [crates/migrator/src/migrator.rs82-110](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L82-L110>) [crates/migrator/src/migrations.rs103-137](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrations.rs#L103-L137>)

## Migration Registry

All migrations are registered in chronological order:

Migration Date| Type| Target| Purpose  
---|---|---|---  
2025-01-02| TreeSitter| Settings| Initial settings format updates  
2025-01-29| TreeSitter| Settings, Keymap| Action and setting renames  
2025-03-03| TreeSitter| Keymap| Keymap action updates  
2025-10-01| JSON| Settings| Flatten code actions formatters  
2025-10-02| JSON| Settings| Remove formatters_on_save  
2025-10-17| JSON| Settings| Make file_finder.include_ignored an enum  
2025-11-25| JSON| Settings| Remove context_server source field  
  
The full list is maintained in `migrate_settings()` and `migrate_keymap()` functions, which run migrations sequentially. Each migration is additive - new migrations are appended to the list, never modified.

Sources: [crates/migrator/src/migrator.rs120-241](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L120-L241>) [crates/migrator/src/migrations.rs1-174](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrations.rs#L1-L174>)

## Creating New Migrations

### Guidelines

When creating a migration:

  1. **Never modify existing migrations** : This ensures users at any version can smoothly upgrade
  2. **Always create new migration modules** : Add to `crates/migrator/src/migrations/m_YYYY_MM_DD.rs`
  3. **Write only x-1 to x logic** : Users' internal state will always be at x-1, even if their files are older
  4. **Test thoroughly** : Migrations run on user configuration files and errors can break the editor


From the migration system documentation:

> "You _must not_ modify previous migrations; always create new ones instead. This is important because if a user is in an intermediate state, they can smoothly transition to the latest state. Modifying existing migrations means they will only work for users upgrading from version x-1 to x, but not from x-2 to x"

Sources: [crates/migrator/src/migrator.rs1-16](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L1-L16>)

### TreeSitter Migration Example

To create a TreeSitter migration:

  1. **Define the query** using tree-sitter patterns from `crates/migrator/src/patterns.rs`
  2. **Create pattern callbacks** that identify what to replace and generate new text
  3. **Register in migration list** in `migrate_settings()` or `migrate_keymap()`


Example structure:


Sources: [crates/migrator/src/migrator.rs1-67](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L1-L67>) [crates/migrator/src/patterns.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/patterns.rs>)

### JSON Migration Example

To create a JSON migration:

  1. **Write transformation function** that takes `&mut serde_json::Value`
  2. **Modify the value tree** using standard Rust code
  3. **Register as`MigrationType::Json`** in the migration list


Example:


Sources: [crates/migrator/src/migrator.rs82-110](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L82-L110>) [crates/migrator/src/migrations.rs103-137](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrations.rs#L103-L137>)

## Migration UI


The `MigrationBanner` component appears in the workspace toolbar when migrations are available. It provides:

  * **Migrate button** : Applies migrations and saves files
  * **View Diff** : Opens a diff editor showing old vs new settings (not yet implemented)
  * **Dismiss** : Marks migration as attempted without applying


The banner tracks migration state for both settings and keymap files independently, showing a combined prompt if both need migration.

Sources: [crates/zed/src/zed/migrate.rs24-305](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/zed/src/zed/migrate.rs#L24-L305>)

## Integration with Settings Store

The `SettingsStore` integrates migration at several points:

  1. **File Loading** : When `load_settings()` or `reload_user_settings_file()` is called, contents are passed through the migrator
  2. **Status Storage** : Migration status is stored per file in `file_errors` BTreeMap using `SettingsFile` enum as key
  3. **Status Queries** : `migration_status()` method provides current status for any file type
  4. **Write Operations** : `write_user_settings()` and similar methods are used by the migration UI to save migrated content


The store maintains a clear separation:

  * **SettingsStore** : Manages in-memory settings values and file I/O
  * **Migrator** : Pure transformation functions with no file system access
  * **MigrationBanner** : UI layer that coordinates user actions


Sources: [crates/settings/src/settings_store.rs846-906](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L846-L906>) [crates/settings/src/settings_store.rs1033-1118](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L1033-L1118>)

## Migration Status API


Key methods:

  * `migration_status(file: SettingsFile) -> Option<MigrationStatus>`: Returns current migration status
  * `set_migration_status(file: SettingsFile, status: MigrationStatus)`: Updates migration status
  * `reload_user_settings_file(cx) -> Task<Result<()>>`: Reloads settings file, checking for needed migrations
  * `write_user_settings(settings_content, cx) -> Result<()>`: Writes settings to disk


Sources: [crates/settings/src/settings_store.rs763-906](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/settings/src/settings_store.rs#L763-L906>)

## File Format Evolution

Migration becomes necessary when:

  1. **Setting renamed** : Old key name changes (e.g., `vim_mode` â†’ `vim.enabled`)
  2. **Type changed** : Boolean becomes enum, string becomes object, etc.
  3. **Structure changed** : Nested object becomes flat, or vice versa
  4. **Action renamed** : Keymap action names change
  5. **Deprecation** : Old settings removed in favor of new ones


The migration system ensures all these changes are handled transparently, preserving user intent while updating to the new format.

Sources: [crates/migrator/src/migrator.rs1-16](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrator.rs#L1-L16>) [crates/migrator/src/migrations.rs1-174](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/migrator/src/migrations.rs#L1-L174>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [Settings Migration](<#settings-migration>)
  * [Purpose and Scope](<#purpose-and-scope>)
  * [Migration System Overview](<#migration-system-overview>)
  * [Architecture Components](<#architecture-components>)
  * [Core Migration Types](<#core-migration-types>)
  * [MigrationType Enum](<#migrationtype-enum>)
  * [Migration Status Tracking](<#migration-status-tracking>)
  * [Migration Workflow](<#migration-workflow>)
  * [TreeSitter-Based Migrations](<#treesitter-based-migrations>)
  * [Migration Pattern Structure](<#migration-pattern-structure>)
  * [Example Migration Flow](<#example-migration-flow>)
  * [JSON-Based Migrations](<#json-based-migrations>)
  * [Migration Registry](<#migration-registry>)
  * [Creating New Migrations](<#creating-new-migrations>)
  * [Guidelines](<#guidelines>)
  * [TreeSitter Migration Example](<#treesitter-migration-example>)
  * [JSON Migration Example](<#json-migration-example>)
  * [Migration UI](<#migration-ui>)
  * [Integration with Settings Store](<#integration-with-settings-store>)
  * [Migration Status API](<#migration-status-api>)
  * [File Format Evolution](<#file-format-evolution>)
