<!-- Source: https://deepwiki.com/zed-industries/zed/12.4-crdt-and-synchronization -->

# 12.4 Crdt And Synchronization

Loading...

Index your code with Devin

[DeepWiki](</>)

[DeepWiki](</>)

[zed-industries/zed ](<https://github.com/zed-industries/zed> "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 16 December 2025 ([4109c9](<https://github.com/zed-industries/zed/commits/4109c9dd>))

  * [Overview](</zed-industries/zed/1-overview>)
  * [Core Architecture](</zed-industries/zed/2-core-architecture>)
  * [Application Initialization and Lifecycle](</zed-industries/zed/2.1-application-initialization-and-lifecycle>)
  * [GPUI Framework](</zed-industries/zed/2.2-gpui-framework>)
  * [Window and Platform Abstraction](</zed-industries/zed/2.3-window-and-platform-abstraction>)
  * [Event Flow and Input Handling](</zed-industries/zed/2.4-event-flow-and-input-handling>)
  * [Keybinding and Action System](</zed-industries/zed/2.5-keybinding-and-action-system>)
  * [Focus Management and Hit Testing](</zed-industries/zed/2.6-focus-management-and-hit-testing>)
  * [Editor Architecture](</zed-industries/zed/3-editor-architecture>)
  * [Editor Component and UI](</zed-industries/zed/3.1-editor-component-and-ui>)
  * [Buffer System and Text Storage](</zed-industries/zed/3.2-buffer-system-and-text-storage>)
  * [Display Pipeline and Rendering](</zed-industries/zed/3.3-display-pipeline-and-rendering>)
  * [Selections and Editing Operations](</zed-industries/zed/3.4-selections-and-editing-operations>)
  * [Code Intelligence Integration](</zed-industries/zed/3.5-code-intelligence-integration>)
  * [Diff Integration](</zed-industries/zed/3.6-diff-integration>)
  * [Workspace and Panel System](</zed-industries/zed/4-workspace-and-panel-system>)
  * [Workspace Organization](</zed-industries/zed/4.1-workspace-organization>)
  * [Item System and Lifecycle](</zed-industries/zed/4.2-item-system-and-lifecycle>)
  * [Pane Management](</zed-industries/zed/4.3-pane-management>)
  * [Search System](</zed-industries/zed/4.4-search-system>)
  * [Project Management](</zed-industries/zed/5-project-management>)
  * [Project Orchestration](</zed-industries/zed/5.1-project-orchestration>)
  * [Worktree and File System](</zed-industries/zed/5.2-worktree-and-file-system>)
  * [Buffer Store](</zed-industries/zed/5.3-buffer-store>)
  * [Language Intelligence](</zed-industries/zed/6-language-intelligence>)
  * [LSP Store Architecture](</zed-industries/zed/6.1-lsp-store-architecture>)
  * [Language Server Lifecycle](</zed-industries/zed/6.2-language-server-lifecycle>)
  * [Completions and Diagnostics](</zed-industries/zed/6.3-completions-and-diagnostics>)
  * [Multi-Language Server Coordination](</zed-industries/zed/6.4-multi-language-server-coordination>)
  * [Settings and Configuration](</zed-industries/zed/7-settings-and-configuration>)
  * [Settings Store and Layering](</zed-industries/zed/7.1-settings-store-and-layering>)
  * [Settings UI](</zed-industries/zed/7.2-settings-ui>)
  * [Settings Migration](</zed-industries/zed/7.3-settings-migration>)
  * [Keymap System](</zed-industries/zed/7.4-keymap-system>)
  * [Git Integration](</zed-industries/zed/8-git-integration>)
  * [Git Panel and UI](</zed-industries/zed/8.1-git-panel-and-ui>)
  * [Git Store and State Management](</zed-industries/zed/8.2-git-store-and-state-management>)
  * [Repository Operations](</zed-industries/zed/8.3-repository-operations>)
  * [Diff System](</zed-industries/zed/8.4-diff-system>)
  * [Terminal and Task Execution](</zed-industries/zed/9-terminal-and-task-execution>)
  * [Terminal Core](</zed-industries/zed/9.1-terminal-core>)
  * [Terminal View and Rendering](</zed-industries/zed/9.2-terminal-view-and-rendering>)
  * [Task System](</zed-industries/zed/9.3-task-system>)
  * [Vim Mode](</zed-industries/zed/10-vim-mode>)
  * [Mode State Machine](</zed-industries/zed/10.1-mode-state-machine>)
  * [Operators, Motions, and Objects](</zed-industries/zed/10.2-operators-motions-and-objects>)
  * [Visual Mode](</zed-industries/zed/10.3-visual-mode>)
  * [Helix Mode Integration](</zed-industries/zed/10.4-helix-mode-integration>)
  * [AI Agent System](</zed-industries/zed/11-ai-agent-system>)
  * [Agent Communication Protocol (ACP)](</zed-industries/zed/11.1-agent-communication-protocol-\(acp\)>)
  * [Agent UI and Thread Management](</zed-industries/zed/11.2-agent-ui-and-thread-management>)
  * [Agent Connection and Implementations](</zed-industries/zed/11.3-agent-connection-and-implementations>)
  * [Tool System](</zed-industries/zed/11.4-tool-system>)
  * [Mention System and Context](</zed-industries/zed/11.5-mention-system-and-context>)
  * [Legacy Agent Thread System](</zed-industries/zed/11.6-legacy-agent-thread-system>)
  * [Remote Development and Collaboration](</zed-industries/zed/12-remote-development-and-collaboration>)
  * [Local vs Remote Architecture](</zed-industries/zed/12.1-local-vs-remote-architecture>)
  * [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>)
  * [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>)
  * [CRDT and Synchronization](</zed-industries/zed/12.4-crdt-and-synchronization>)


Menu

# CRDT and Synchronization

Relevant source files

  * [crates/buffer_diff/src/buffer_diff.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/buffer_diff/src/buffer_diff.rs>)
  * [crates/editor/src/actions.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/actions.rs>)
  * [crates/editor/src/code_completion_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/code_completion_tests.rs>)
  * [crates/editor/src/code_context_menus.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/code_context_menus.rs>)
  * [crates/editor/src/editor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor.rs>)
  * [crates/editor/src/editor_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_tests.rs>)
  * [crates/editor/src/element.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/element.rs>)
  * [crates/language/src/buffer.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs>)
  * [crates/language/src/buffer_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer_tests.rs>)
  * [crates/language/src/syntax_map.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/syntax_map.rs>)
  * [crates/multi_buffer/src/anchor.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/anchor.rs>)
  * [crates/multi_buffer/src/multi_buffer.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer.rs>)
  * [crates/multi_buffer/src/multi_buffer_tests.rs](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/multi_buffer_tests.rs>)


## Purpose and Scope

This document explains Zed's CRDT (Conflict-free Replicated Data Type) based text synchronization system, which enables local editing, remote development, and real-time collaboration without conflicts. The system provides:

  * CRDT-based text storage with automatic conflict resolution
  * Stable position references (anchors) that maintain validity across edits
  * Operation-based synchronization between buffer replicas
  * Version vector tracking for distributed state management
  * Support for both local and remote buffer replicas


For information about remote project architecture and RPC communication, see [Remote Project Architecture](</zed-industries/zed/12.2-remote-project-architecture>). For collaboration UI features like shared cursors and following, see [Collaboration Features](</zed-industries/zed/12.3-collaboration-features>).

* * *

## CRDT-Based Text Storage

### TextBuffer and the Buffer Wrapper

Zed's text storage is built on a CRDT foundation provided by the `text` crate. The `Buffer` type in the `language` crate wraps this with additional language features:


**Sources:** [crates/language/src/buffer.rs95-134](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L95-L134>) [crates/language/src/buffer.rs26-27](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L26-L27>)

### Replica Identity and Capabilities

Each buffer instance has a unique replica ID and capability level:

Component| Type| Purpose  
---|---|---  
`ReplicaId`| `clock::ReplicaId`| Uniquely identifies each buffer replica in distributed system  
`Capability`| `ReadWrite` or `ReadOnly`| Controls whether replica can generate edits  
Version Vector| `clock::Global`| Tracks causal ordering of operations across replicas  
Lamport Timestamp| `clock::Lamport`| Provides total ordering for concurrent operations  
  
**Sources:** [crates/language/src/buffer.rs83-89](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L83-L89>) [crates/language/src/buffer.rs26](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L26-L26>)

* * *

## Operation Types and Propagation

### Operation Enum

All buffer changes are represented as operations that can be synchronized:


**Sources:** [crates/language/src/buffer.rs294-340](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L294-L340>)

### Operation Flow Between Replicas


**Sources:** [crates/language/src/buffer.rs342-373](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L342-L373>) [crates/editor/src/editor_tests.rs82-105](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_tests.rs#L82-L105>)

### Creating and Synchronizing Replicas

The pattern for creating a replica from an existing buffer:

  1. **Serialize base state** : `buffer.to_proto(cx)` creates a snapshot of buffer state
  2. **Serialize operations** : `buffer.serialize_ops(None, cx)` gets all historical operations
  3. **Create replica** : `Buffer::from_proto(replica_id, capability, state, file)` creates new instance
  4. **Apply operations** : `replica.apply_ops(ops, cx)` brings replica up to date


**Sources:** [crates/editor/src/editor_tests.rs75-105](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_tests.rs#L75-L105>)

* * *

## Anchors: Stable Position References

### Text Anchors

Text anchors are CRDT-based position references that remain valid across edits:


An anchor's position is determined by:

  * Its **timestamp** : when the position was created
  * Its **offset** : position in the text at creation time
  * Its **bias** : whether it gravitates left or right at edit boundaries


**Sources:** [crates/language/src/buffer.rs62-67](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L62-L67>) [crates/multi_buffer/src/anchor.rs1-30](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/anchor.rs#L1-L30>)

### Multi-Buffer Anchors

Multi-buffer anchors extend text anchors to work across multiple excerpts:

Field| Type| Purpose  
---|---|---  
`excerpt_id`| `ExcerptId`| Identifies which excerpt contains this position  
`text_anchor`| `text::Anchor`| Position within the excerpt's buffer  
`diff_base_anchor`| `Option<text::Anchor>`| Optional position in diff base text for git hunks  
  
**Sources:** [crates/multi_buffer/src/anchor.rs12-49](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/anchor.rs#L12-L49>)

### Anchor Comparison Logic


**Sources:** [crates/multi_buffer/src/anchor.rs83-131](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/anchor.rs#L83-L131>)

* * *

## Version Tracking and Causality

### Version Vectors

Buffers use version vectors (`clock::Global`) to track causal relationships between operations:


**Sources:** [crates/language/src/buffer.rs105-106](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L105-L106>)

### Version-Based Operations

Key operations using version tracking:

Operation| Version Check| Purpose  
---|---|---  
`has_unsaved_edits()`| Compares current version with `saved_version`| Determines if buffer is dirty  
`can_undo()`| Checks transaction history| Determines if undo is available  
`is_dirty()`| Version comparison| Shows buffer state in UI  
`serialize_ops(since)`| Filters ops by version| Sends only new operations to replicas  
  
**Sources:** [crates/language/src/buffer.rs95-134](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L95-L134>)

* * *

## Synchronizing Additional State

### Selection Synchronization

Cursor positions and selections are synchronized as operations:


The `UpdateSelections` operation includes:

  * **selections** : `Arc<[Selection<Anchor>]>` \- the cursor/selection positions
  * **lamport_timestamp** : for conflict resolution when multiple users edit simultaneously
  * **line_mode** : whether selections are in line mode (vim visual line)
  * **cursor_shape** : the visual representation of the cursor


**Sources:** [crates/language/src/buffer.rs311-320](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L311-L320>) [crates/language/src/buffer.rs236-241](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L236-L241>)

### Diagnostics Synchronization

LSP diagnostics are also synchronized as operations:


Each diagnostic is stored with `Anchor` positions so it remains valid across edits, even when synchronized to remote replicas.

**Sources:** [crates/language/src/buffer.rs301-308](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L301-L308>) [crates/language/src/buffer.rs244-285](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L244-L285>)

* * *

## Remote Buffer Architecture

### Local vs Remote Buffers


**Sources:** [crates/language/src/buffer.rs83-89](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L83-L89>) [crates/editor/src/editor_tests.rs75-105](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_tests.rs#L75-L105>)

### Operation Serialization

Operations are serialized to protocol buffers for network transmission:

  1. **to_proto()** : Converts buffer state to `proto::Buffer` message
  2. **serialize_ops()** : Converts operations to `proto::Operation` messages
  3. **from_proto()** : Reconstructs buffer from proto message
  4. **apply_ops()** : Applies deserialized operations to buffer


**Sources:** [crates/language/src/buffer.rs62-67](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L62-L67>)

* * *

## Conflict Resolution

### CRDT Guarantees

The CRDT system provides automatic conflict resolution with these guarantees:

Property| Description| Implementation  
---|---|---  
**Commutativity**|  Operations can be applied in any order| Version vector ordering ensures convergence  
**Associativity**|  Grouping of operations doesn't matter| Text operations use Lamport timestamps  
**Idempotency**|  Applying same operation twice is safe| Operations include unique IDs for deduplication  
**Convergence**|  All replicas reach same state| CRDT algorithm ensures eventual consistency  
  
### Example: Concurrent Edits

When two users edit simultaneously:


The CRDT automatically resolves the position conflict - no manual merge needed.

**Sources:** [crates/language/src/buffer.rs294-340](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L294-L340>) [crates/editor/src/editor_tests.rs82-105](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/editor/src/editor_tests.rs#L82-L105>)

* * *

## Performance Considerations

### Deferred Operations

The buffer maintains an `OperationQueue` for deferred operations:


Operations may be deferred if they depend on other operations that haven't arrived yet (out-of-order delivery).

**Sources:** [crates/language/src/buffer.rs125](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L125-L125>)

### Memory Efficiency

Anchors and operations are designed for memory efficiency:

  * **Anchors** : Small size (timestamp + offset + bias + buffer_id)
  * **Arc sharing** : Operations use `Arc<[T]>` for shared data
  * **Rope structure** : Text is stored in a rope (balanced tree) for efficient insertion/deletion
  * **Incremental updates** : Only changed regions are re-parsed/re-highlighted


**Sources:** [crates/multi_buffer/src/anchor.rs12-16](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/multi_buffer/src/anchor.rs#L12-L16>) [crates/language/src/buffer.rs301-331](<https://github.com/zed-industries/zed/blob/4109c9dd/crates/language/src/buffer.rs#L301-L331>)

Dismiss

Refresh this wiki

This wiki was recently refreshed. Please wait 7 days to refresh again.

### On this page

  * [CRDT and Synchronization](<#crdt-and-synchronization>)
  * [Purpose and Scope](<#purpose-and-scope>)
  * [CRDT-Based Text Storage](<#crdt-based-text-storage>)
  * [TextBuffer and the Buffer Wrapper](<#textbuffer-and-the-buffer-wrapper>)
  * [Replica Identity and Capabilities](<#replica-identity-and-capabilities>)
  * [Operation Types and Propagation](<#operation-types-and-propagation>)
  * [Operation Enum](<#operation-enum>)
  * [Operation Flow Between Replicas](<#operation-flow-between-replicas>)
  * [Creating and Synchronizing Replicas](<#creating-and-synchronizing-replicas>)
  * [Anchors: Stable Position References](<#anchors-stable-position-references>)
  * [Text Anchors](<#text-anchors>)
  * [Multi-Buffer Anchors](<#multi-buffer-anchors>)
  * [Anchor Comparison Logic](<#anchor-comparison-logic>)
  * [Version Tracking and Causality](<#version-tracking-and-causality>)
  * [Version Vectors](<#version-vectors>)
  * [Version-Based Operations](<#version-based-operations>)
  * [Synchronizing Additional State](<#synchronizing-additional-state>)
  * [Selection Synchronization](<#selection-synchronization>)
  * [Diagnostics Synchronization](<#diagnostics-synchronization>)
  * [Remote Buffer Architecture](<#remote-buffer-architecture>)
  * [Local vs Remote Buffers](<#local-vs-remote-buffers>)
  * [Operation Serialization](<#operation-serialization>)
  * [Conflict Resolution](<#conflict-resolution>)
  * [CRDT Guarantees](<#crdt-guarantees>)
  * [Example: Concurrent Edits](<#example-concurrent-edits>)
  * [Performance Considerations](<#performance-considerations>)
  * [Deferred Operations](<#deferred-operations>)
  * [Memory Efficiency](<#memory-efficiency>)
